<html>
<head>
<title>Critical Sections FAQ</title>
<link rel="stylesheet" type="text/css" href="style.css">
<meta charset="UTF-8">
</head>
<body>
<div id="fb_body_wrapper">
<div id="fb_tab">
<div id="fb_tab_l">Critical Sections FAQ</div>
<div id="fb_tab_r">&nbsp;<a href="00index.html"><img src="images/fblogo_mini.gif" /></a></div> 
</div> 
<div id="fb_pg_wrapper">
<div id="fb_pg_body">
	The "<b>Critical Sections</b>" related questions in multi-threading.<br \>
<a name="ProPgMtCriticalSectionsFAQtop"></a><br \>
<b></b><div class="fb_sect_title">'Critical sections' related questions</div><div class="fb_sect_cont"><b><br \>
</b><a href="#ProPgMtCriticalSectionsFAQ1">1. When is it not mandatory to protect by a mutex one shared variable between several threads?</a><b><br \>
</b><a href="#ProPgMtCriticalSectionsFAQ2">2. What is the chronology of code execution of 2 critical sections (with a mutex locking and a conditional variable signaling) that compete between 2 threads?</a><b><br \>
</b><a href="#ProPgMtCriticalSectionsFAQ3">3. What happens if calling 'Condsignal()' or 'Condbroadcast()' without mutex locked?</a><b><br \>
</b><a href="#ProPgMtCriticalSectionsFAQ4">4. Why it is mandatory to put 'Condwait' within a 'While...Wend' loop for checking a Boolean predicate (set by other thread before activate 'Condsignal' or 'Condbroadcast', and reset after the 'Wend')?</a><b><br \>
<div class="fb_indent"></b><a href="#ProPgMtCriticalSectionsFAQ4.1">4.1. Is 'Condwait' (and 'Condsignal' or 'Condbroadcast') still useful when there is already a 'While' loop for checking a Boolean predicate set by other thread?</a><b><br \>
</div></b><a href="#ProPgMtCriticalSectionsFAQ5">5. How to implement a user input-line function fully thread-safe?</a><b><br \>
</b><a href="#ProPgMtCriticalSectionsFAQ6">6. How to use 'Screenlock' with multi-threading?</a><b><br \>
</b><a href="#ProPgMtCriticalSectionsFAQ7">7. How to use 'video paging (double buffering or page flipping)' with multi-threading?</a><b><br \>
</b><a href="#ProPgMtCriticalSectionsFAQ8">8. How to use the FB runtime library for multi-threaded applications (gfxlib2) with multi-threading?</a><b><br \>
</b><a href="#ProPgMtCriticalSectionsFAQ9">9. How to use console statements and keyboard inputs with multi-threading?</a><b><br \>
</b><a href="#ProPgMtCriticalSectionsFAQ10">10. Is it better to take precautions when using the keyword 'Sleep' in threads?</a><b><br \>
</b><a href="#ProPgMtCriticalSectionsFAQ11">11. Can all tools to handle multi-threading be encapsulated in a base Class (that the user extends with a derived Type for his own implementing)?</a><b><br \>
</b><a href="#ProPgMtCriticalSectionsFAQ12">12. Can we emulate a kind of TLS (Thread Local Storage) with FreeBASIC?</a><b><br \>
</b><a href="#ProPgMtCriticalSectionsFAQ13">13. Can we emulate a kind of thread pooling feature with FreeBASIC?</a><b><br \>
<br \>
<br \>
<br \>
<br \>
<div style="text-align: center;"></b><div class="fb_header">'Critical sections' related questions</div><b></div><br \>
<br \>
<a name="ProPgMtCriticalSectionsFAQ1"></a><br \>
</b></div><div class="fb_sect_title">1. When is it not mandatory to protect by a mutex one shared variable between several threads?</div><div class="fb_sect_cont"><br \>
<div class="fb_indent">When accessing to shared variables between several threads, all their accesses must be generally put inside blocks <tt><i>Mutexlock...Mutexunlock</i></tt>, in all threads:<br \>
<div class="fb_indent"><b>-</b> When the shared variable is only one simple predefined numeric type of <tt><i>size &lt;= sizeof(integer)</i></tt> (only one assembler instruction for access), the mutex use may be not mandatory.<br \>
<b>-</b> But if this is for example one shared variable <tt><i>LongInt</i></tt> with a win32 compilation, it is advised here to use a mutex (otherwise the reading phase by a thread may be interlaced with the writing phase of another thread).<br \>
<br \>
</div>That is because to access a variable in memory (for reading or for writing), a processor uses its internal registers.<br \>
A N-bit processor has N-bit registers but none greater:<br \>
<div class="fb_indent"><b>-</b> So one only assembler instruction allows it to access a N-bit variable in memory.<br \>
<b>-</b> At opposite, to access a 2N-bit variable, it must use 2 assembler instructions.<br \>
<b>-</b> If between these two assembler instructions (for writing), another thread accesses this same variable (for reading), the got value may be incoherent (N-bit highest and N-bit lowest incoherent together).<br \>
<br \>
</div>This behavior can be checked with a graphic program using two threads and a shared <tt><i>LongInt</i></tt> (64-bit) without mutex:<br \>
<div class="fb_indent"><b>-</b> by compiling in 32-bit, many read values are incoherent.<br \>
<b>-</b> by compiling in 64-bit, no read value is incoherent.<br \>
<br \>
</div>Compile the below test program:<br \>
<div class="fb_indent"><b>-</b> in 32-bit =&gt; Many erroneous points not on the circle but anywhere in the square containing the circle. If you uncomment the four lines 37/39/58/60 to activate the mutex, then all the got points are now on the circle only.<br \>
<b>-</b> in 64-bit =&gt; All points are valid, on the circle only, even if the mutex is not activated.<br \>
<tt><div class="freebasic">
<span class="com">'&nbsp;&nbsp;&nbsp;-&nbsp;The&nbsp;&quot;user-defined&nbsp;thread&quot;&nbsp;computes&nbsp;the&nbsp;points&nbsp;coordinates&nbsp;on&nbsp;a&nbsp;circle,</span><br />
<span class="com">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;write&nbsp;those&nbsp;in&nbsp;a&nbsp;LongInt&nbsp;(32-bit&nbsp;&amp;&nbsp;32-bit&nbsp;=&nbsp;64-bit)</span><br />
<span class="com">'&nbsp;&nbsp;&nbsp;-&nbsp;The&nbsp;&quot;main&nbsp;thread&quot;&nbsp;plots&nbsp;the&nbsp;points&nbsp;from&nbsp;the&nbsp;LongInt&nbsp;value.</span><br />
<span class="com">'</span><br />
<span class="com">'&nbsp;&nbsp;&nbsp;Behavior:</span><br />
<span class="com">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;The&nbsp;first&nbsp;point&nbsp;must&nbsp;be&nbsp;pre-determined.</span><br />
<span class="com">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Nothing&nbsp;prevents&nbsp;that&nbsp;a&nbsp;same&nbsp;calculated&nbsp;point&nbsp;could&nbsp;be&nbsp;plotted&nbsp;several&nbsp;times</span><br />
<span class="com">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(depends&nbsp;on&nbsp;execution&nbsp;times&nbsp;of&nbsp;the&nbsp;loops&nbsp;between&nbsp;main&nbsp;thread&nbsp;and&nbsp;user&nbsp;thread).</span><br />
<span class="com">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Nothing&nbsp;prevents&nbsp;that&nbsp;a&nbsp;calculated&nbsp;point&nbsp;could&nbsp;be&nbsp;not&nbsp;plotted</span><br />
<span class="com">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(same&nbsp;remark&nbsp;on&nbsp;the&nbsp;loop&nbsp;times).</span><br />
<span class="com">'</span><br />
<span class="com">'&nbsp;&nbsp;&nbsp;Remark:</span><br />
<span class="com">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Voluntarily,&nbsp;there&nbsp;is&nbsp;no&nbsp;Sleep&nbsp;in&nbsp;the&nbsp;loop&nbsp;of&nbsp;each&nbsp;thread&nbsp;(normally&nbsp;strongly&nbsp;discouraged),</span><br />
<span class="com">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;but&nbsp;this&nbsp;is&nbsp;just&nbsp;in&nbsp;this&nbsp;special&nbsp;case&nbsp;to&nbsp;amplify&nbsp;the&nbsp;behavior&nbsp;effects&nbsp;to&nbsp;observe.</span><br />
<br />
<br />
<span class="key">Union</span>&nbsp;<span class="wrd">Point2D</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">LongInt</span>&nbsp;<span class="wrd">xy</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Type</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Long</span>&nbsp;<span class="wrd">y</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Long</span>&nbsp;<span class="wrd">x</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">Type</span><br />
<span class="key">End</span>&nbsp;<span class="key">Union</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">handle</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">mutex</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">quit</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">Thread</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">param</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Const</span>&nbsp;<span class="wrd">pi</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Single</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">4</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">Atn</span><span class="oth">(</span><span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">Point2D</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">param</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">Point2D</span>&nbsp;<span class="wrd">P2D0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Single</span>&nbsp;<span class="wrd">teta</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">2</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="wrd">pi</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">Rnd</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">P2D0.x</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">320</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">200</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">Cos</span><span class="oth">(</span><span class="wrd">teta</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">P2D0.y</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">240</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">200</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">Sin</span><span class="oth">(</span><span class="wrd">teta</span><span class="oth">)</span><br />
<span class="com">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Mutexlock(mutex)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">p</span><span class="oth">-&gt;</span><span class="wrd">xy</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">P2D0.xy</span><br />
<span class="com">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Mutexunlock(mutex)</span><br />
<span class="com">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sleep&nbsp;5,&nbsp;1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="wrd">quit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<br />
<span class="key">Screen</span>&nbsp;<span class="num">12</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">Point2D</span>&nbsp;<span class="wrd">P2D</span><br />
<span class="wrd">P2D.x</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">520</span><br />
<span class="wrd">P2D.y</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">240</span><br />
<br />
<span class="wrd">mutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><br />
<span class="wrd">handle</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">Thread</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">P2D</span><span class="oth">)</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">c</span><br />
<br />
<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">Point2D</span>&nbsp;<span class="wrd">P2D0</span><br />
<span class="com">'&nbsp;&nbsp;&nbsp;&nbsp;Mutexlock(mutex)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">P2D0.xy</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">P2D.xy</span><br />
<span class="com">'&nbsp;&nbsp;&nbsp;&nbsp;Mutexunlock(mutex)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">PSet</span>&nbsp;<span class="oth">(</span><span class="wrd">P2D0.x</span><span class="oth">,</span>&nbsp;<span class="wrd">P2D0.y</span><span class="oth">),</span>&nbsp;<span class="wrd">c</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">c</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="oth">(</span><span class="wrd">c</span>&nbsp;<span class="key">Mod</span>&nbsp;<span class="num">15</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><br />
<span class="com">'&nbsp;&nbsp;&nbsp;&nbsp;Sleep&nbsp;5,&nbsp;1</span><br />
<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="key">Inkey</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="quo">&quot;&quot;</span><br />
&nbsp;<br />
<span class="wrd">quit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
<span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">handle</span><span class="oth">)</span><br />
<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
</div></div><div style="text-align: center;"><a href="#ProPgMtCriticalSectionsFAQtop">Back to top</a></div><br \>
<a name="ProPgMtCriticalSectionsFAQ2"></a><br \>
</div><div class="fb_sect_title">2. What is the chronology of code execution of 2 critical sections (with a mutex locking and a conditional variable signaling) that compete between 2 threads?</div><div class="fb_sect_cont"><br \>
<div class="fb_indent">Chronology for one thread signaling which occurs:<br \>
<div class="fb_indent">a) while another thread is waiting (within a While loop on predicate),<br \>
b) before another thread is waiting (within a While loop on predicate).<br \>
<tt><div class="freebasic">
<span class="def">#define&nbsp;while_loop_on_predicate<br />
</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">handle</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">mutex</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">cond</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">sleep0</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">sleep1</span><br />
<span class="def">#ifdef&nbsp;while_loop_on_predicate<br />
</span><span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">ready</span><br />
<span class="def">#endif<br />
</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">Thread1</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">param</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="oth">*</span><span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span>&nbsp;<span class="key">Ptr</span><span class="oth">,</span>&nbsp;<span class="wrd">param</span><span class="oth">),</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Color</span>&nbsp;<span class="num">11</span>&nbsp;<span class="oth">:</span>&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread#1&nbsp;locks&nbsp;the&nbsp;mutex&quot;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Color</span>&nbsp;<span class="num">11</span>&nbsp;<span class="oth">:</span>&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread#1&nbsp;executes&nbsp;code&nbsp;with&nbsp;exclusion&quot;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#ifdef&nbsp;while_loop_on_predicate<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">ready</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#endif<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Color</span>&nbsp;<span class="num">11</span>&nbsp;<span class="oth">:</span>&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread#1&nbsp;is&nbsp;signaling&quot;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondSignal</span><span class="oth">(</span><span class="wrd">cond</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Color</span>&nbsp;<span class="num">11</span>&nbsp;<span class="oth">:</span>&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread#1&nbsp;executes&nbsp;post-code&nbsp;with&nbsp;exclusion&quot;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Color</span>&nbsp;<span class="num">11</span>&nbsp;<span class="oth">:</span>&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread#1&nbsp;unlocks&nbsp;the&nbsp;mutex&quot;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">Thread0</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">param</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="oth">*</span><span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span>&nbsp;<span class="key">Ptr</span><span class="oth">,</span>&nbsp;<span class="wrd">param</span><span class="oth">),</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Color</span>&nbsp;<span class="num">10</span>&nbsp;<span class="oth">:</span>&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;&nbsp;&nbsp;Thread#0&nbsp;locks&nbsp;the&nbsp;mutex&quot;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Color</span>&nbsp;<span class="num">10</span>&nbsp;<span class="oth">:</span>&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;&nbsp;&nbsp;Thread#0&nbsp;executes&nbsp;pre-code&nbsp;with&nbsp;exclusion&quot;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#ifdef&nbsp;while_loop_on_predicate<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">While</span>&nbsp;<span class="wrd">ready</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#endif<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Color</span>&nbsp;<span class="num">10</span>&nbsp;<span class="oth">:</span>&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;&nbsp;&nbsp;Thread#0&nbsp;is&nbsp;waiting&quot;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondWait</span><span class="oth">(</span><span class="wrd">cond</span><span class="oth">,</span>&nbsp;<span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Color</span>&nbsp;<span class="num">10</span>&nbsp;<span class="oth">:</span>&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;&nbsp;&nbsp;Thread#0&nbsp;is&nbsp;waked&quot;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#ifdef&nbsp;while_loop_on_predicate<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Wend</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#endif<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Color</span>&nbsp;<span class="num">10</span>&nbsp;<span class="oth">:</span>&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;&nbsp;&nbsp;Thread#0&nbsp;executes&nbsp;code&nbsp;with&nbsp;exclusion&quot;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#ifdef&nbsp;while_loop_on_predicate<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">ready</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#endif<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Color</span>&nbsp;<span class="num">10</span>&nbsp;<span class="oth">:</span>&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;&nbsp;&nbsp;Thread#0&nbsp;unlocks&nbsp;the&nbsp;mutex&quot;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<br />
<span class="wrd">mutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><br />
<span class="wrd">cond</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">CondCreate</span><br />
<br />
<span class="wrd">sleep0</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
<span class="wrd">sleep1</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1000</span><br />
<span class="key">Color</span>&nbsp;<span class="num">7</span>&nbsp;<span class="oth">:</span>&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;Chronology&nbsp;for&nbsp;Thread#1&nbsp;signaling&nbsp;while&nbsp;Thread#0&nbsp;is&nbsp;waiting:&quot;</span><br />
<span class="wrd">handle</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">Thread1</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">sleep1</span><span class="oth">)</span><br />
<span class="wrd">Thread0</span><span class="oth">(@</span><span class="wrd">sleep0</span><span class="oth">)</span><br />
<span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">handle</span><span class="oth">)</span><br />
<span class="key">Color</span>&nbsp;<span class="num">7</span>&nbsp;<span class="oth">:</span>&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;Thread#1&nbsp;finished&quot;</span><span class="oth">:</span>&nbsp;<span class="key">Print</span><br />
<span class="key">Sleep</span>&nbsp;<span class="num">1000</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<br />
<span class="wrd">sleep0</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1000</span><br />
<span class="wrd">sleep1</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
<span class="key">Color</span>&nbsp;<span class="num">7</span>&nbsp;<span class="oth">:</span>&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;Chronology&nbsp;for&nbsp;Thread#1&nbsp;signaling&nbsp;before&nbsp;Thread#0&nbsp;is&nbsp;waiting:&quot;</span><br />
<span class="wrd">handle</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">Thread1</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">sleep1</span><span class="oth">)</span><br />
<span class="wrd">Thread0</span><span class="oth">(@</span><span class="wrd">sleep0</span><span class="oth">)</span><br />
<span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">handle</span><span class="oth">)</span><br />
<span class="key">Color</span>&nbsp;<span class="num">7</span>&nbsp;<span class="oth">:</span>&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;Thread#1&nbsp;finished&quot;</span><span class="oth">:</span>&nbsp;<span class="key">Print</span><br />
<br />
<br />
<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
<span class="key">CondDestroy</span><span class="oth">(</span><span class="wrd">cond</span><span class="oth">)</span><br />
<span class="key">Sleep</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
Output part a - Chronology for Thread#1 signaling while Thread#0 is waiting:<br \>
<div class="fb_indent"><pre class="fb_pre">
Chronology for Thread#1 signaling while Thread#0 is waiting:
	Thread#0 locks the mutex
	Thread#0 executes pre-code with exclusion
	Thread#0 is waiting
		Thread#1 locks the mutex
		Thread#1 executes code with exclusion
		Thread#1 is signaling
		Thread#1 executes post-code with exclusion
		Thread#1 unlocks the mutex
	Thread#0 is waked
	Thread#0 executes code with exclusion
	Thread#0 unlocks the mutex
Thread#1 finished
				</pre></div>Output part b - Chronology for Thread#1 signaling before Thread#0 is waiting:<br \>
<div class="fb_indent"><pre class="fb_pre">
Chronology for Thread#1 signaling before Thread#0 is waiting:
		Thread#1 locks the mutex
		Thread#1 executes code with exclusion
		Thread#1 is signaling
		Thread#1 executes post-code with exclusion
		Thread#1 unlocks the mutex
	Thread#0 locks the mutex
	Thread#0 executes pre-code with exclusion
	Thread#0 executes code with exclusion
	Thread#0 unlocks the mutex
Thread#1 finished	
				</pre></div><b>Note:</b> If <tt><i>CondWait</i></tt> is not within a <tt><i>While</i></tt> loop on predicate (by putting in comment the first line of above program), one can check in the second case (thread#1 signaling before thread#0 waiting), that thread#0 remains blocked in its waiting phase (Ctrl-C to quit).<br \>
<br \>
</div></div><div style="text-align: center;"><a href="#ProPgMtCriticalSectionsFAQtop">Back to top</a></div><br \>
<a name="ProPgMtCriticalSectionsFAQ3"></a><br \>
</div><div class="fb_sect_title">3. What happens if calling 'Condsignal()' or 'Condbroadcast()' without mutex locked?</div><div class="fb_sect_cont"><br \>
<div class="fb_indent">Referring to the example 2 on the <tt><a href="ProPgMtCriticalSections.html">Critical Sections</a></tt>, one takes this opportunity to recall that:<br \>
<div class="fb_indent"><b>-</b> The mutex must always be also locked while executing <tt><i>Condsignal()</i></tt> or <tt><i>Condbroadcast()</i></tt> to wake up a thread (it may be unlocked but only after <tt><i>Condsignal()</i></tt> or <tt><i>Condbroadcast()</i></tt>).<br \>
<b>-</b> If the mutex is not locked (or even if the mutex is unlocked only just before executing <tt><i>Condsignal()</i></tt> or <tt><i>Condbroadcast()</i></tt>), the behavior may become unpredictable (it may work or not, depending on the threads configuration and execution real time).<br \>
<br \>
</div>In the example 2 on the <tt><a href="ProPgMtCriticalSections.html">Critical Sections</a></tt> "Synchronous method example using a condwait then a condbroadcast (and a mutex) for all threads":<br \>
<div class="fb_indent"><b>-</b> If one at least <tt><i>Mutexunlock()</i></tt> is moved just before its <tt><i>Condbroadcast()</i></tt>, the program hangs very quickly.<br \>
<b>-</b> Although some users certify that the mutex can always be unlocked just before <tt><i>Condsignal()</i></tt> or <tt><i>Condbroadcast()</i></tt>, and others more cautious assert that one can do it only for a <tt><i>Condbroadcast()</i></tt>, experiment shows the opposite!<br \>
<br \>
</div>The general rule is that:<br \>
<div class="fb_indent"><b>-</b> The condition must not be signaled (by <tt><i>Condsignal()</i></tt> or <tt><i>Condbroadcast()</i></tt>) between the time a thread locks the mutex and the time it waits on the condition variable (<tt><i>CondWait()</i></tt>), otherwise it seems that it may damage the waiting queue of threads on that condition variable.<br \>
<b>-</b> Thus to avoid that and follow this rule, it is necessary that the mutex remains locked when the condition is signaled.<br \>
<br \>
</div></div><div style="text-align: center;"><a href="#ProPgMtCriticalSectionsFAQtop">Back to top</a></div><br \>
<a name="ProPgMtCriticalSectionsFAQ4"></a><br \>
</div><div class="fb_sect_title">4. Why it is mandatory to put 'Condwait' within a 'While...Wend' loop for checking a Boolean predicate (set by other thread before activate 'Condsignal' or 'Condbroadcast', and reset after the 'Wend')?</div><div class="fb_sect_cont"><br \>
<div class="fb_indent"><b><tt><i>While predicate &lt;&gt; True<br \>
<div class="fb_indent">Condwait(conditionalid, mutexid)<br \>
</div>Wend<br \>
predicate = False</i></tt></b><br \>
<br \>
In all documentations, it is highly advisable to do so, mainly justified to fight against eventual spurious wake-ups.<br \>
<br \>
This is probably true, but it is also advisable to do so to avoid to loose a <tt><i>CondSignal</i></tt> (or <tt><i>CondBroadcast</i></tt>) if it is prematurely activated while the receiving thread is not yet waiting on <tt><i>CondWait</i></tt> (the signal is lost forever):<br \>
<div class="fb_indent"><b>-</b> In that case, the receiving thread has even not yet locked the mutex before that <tt><i>CondSignal</i></tt> (or <tt><i>CondBroadcast</i></tt>) is activated.<br \>
<b>-</b> So the predicate will already true before the receiving thread reaches the 'While...Wend' loop, inducing that <tt><i>CondWait</i></tt> is downright skipped, so avoiding a definitive blocking phenomenon.<br \>
<br \>
</div>Let two threads (thread #0 in main program, thread #1 in a user procedure, each that prints its number in a loop), having about the same execution time, and each one synchronizing the other in order to well interlace their numbers (by using one mutex, two condition variables and <tt><i>CondSignal</i></tt>/<tt><i>CondWait</i></tt>):<br \>
</div><ul><ul><ul><li> Without a 'While...Wend' loop on predicate, the program hangs quickly (Ctrl-C to quit):<br \>
</ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><pre class="fb_pre">
'            Thread#0                           XOR + <==>                       Thread#1
'   .....                                                             .....
'   MutexLock(mut) <-------------------------.             .----------> MutexLock(mut)
'   ( atomic_mutex_unlock(mut) ) ------.     |             |            Do_something_with_exclusion
'   CondWait(cond#1, mut) <----------- | --- | ----------- | ---------- CondSignal(cond#1)
'   ( atomic_mutex_re-lock(mut) ) <--- | ----'----.        |     .----- ( atomic_mutex_unlock(mut) )
'   Do_something_with_exclusion        |     .--- | ------ | --- | ---> CondWait(cond#2, mut)
'   CondSignal(cond#2) --------------- | ----'    |    .---'---- | ---> ( atomic_mutex_re-lock(mut) )
'   Do_something_with_exclusion        |     .--- | ---'         |      Do_something_with_exclusion
'   MutexUnlock(mut) ------------------'-----'    '--------------'----- MutexUnlock(mut)
'   .....                                                               .....
'
'  (connecting lines join the sender(s) and receiver(s) impacted by each action occurring during the sequence)
					</pre><tt><div class="freebasic">
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">handle</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">mutex</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">cond1</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">cond2</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">quit</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">Thread</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">param</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;1&quot;</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondSignal</span><span class="oth">(</span><span class="wrd">cond1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondWait</span><span class="oth">(</span><span class="wrd">cond2</span><span class="oth">,</span>&nbsp;<span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">quit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Exit</span>&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<br />
<span class="wrd">mutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><br />
<span class="wrd">cond1</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">CondCreate</span><br />
<span class="wrd">cond2</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">CondCreate</span><br />
<span class="wrd">handle</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">Thread</span><span class="oth">)</span><br />
<br />
<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondWait</span><span class="oth">(</span><span class="wrd">cond1</span><span class="oth">,</span>&nbsp;<span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;0&quot;</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondSignal</span><span class="oth">(</span><span class="wrd">cond2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="key">Inkey</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="quo">&quot;&quot;</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">quit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Exit</span>&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<span class="key">Loop</span><br />
&nbsp;<br />
<span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">handle</span><span class="oth">)</span><br />
<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
<span class="key">CondDestroy</span><span class="oth">(</span><span class="wrd">cond1</span><span class="oth">)</span><br />
<span class="key">CondDestroy</span><span class="oth">(</span><span class="wrd">cond2</span><span class="oth">)</span><br />
<span class="key">Print</span><br />
<br />
<span class="key">Sleep</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
</div></div></div></div><ul><ul><ul><li> With a 'While...Wend' loop on predicate around each <tt><i>CondWait</i></tt>, no blocking phenomenon:<br \>
</ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><pre class="fb_pre">
'            Thread#0                                 XOR + <==>                            Thread#1
'   .....                                                                          .....
'   MutexLock(mut) <-----------------------------.                          .----> MutexLock(mut)
'   While bool#1 <> true <---------------------- | --------.                |      Do_something_with_exclusion
'       ( atomic_mutex_unlock(mut) ) ------.     |         '--------------- | ---- bool#1 = true
'       CondWait(cond#1, mut) <----------- | --- | ------------------------ | ---- CondSignal(cond#1)
'       ( atomic_mutex_re-lock(mut) ) <--- | ----'----.    .--------------- | ---> While bool#2 <> true
'   Wend                                   |          |    |          .---- | -------- ( atomic_mutex_unlock(mut) )
'   bool#1 = false                .------- | -------- | ---'  .------ | --- |--------> CondWait(cond#2, mut)
'   Do_something_with_exclusion   |   .--- | -------- | ------'  .--- | ----'--------> ( atomic_mutex_re-lock(mut) )
'   bool#2 = true ----------------'   |    |     .--- | ---------'    |            Wend
'   CondSignal(cond#2) ---------------'    |     |    |               |            bool#2 = false
'   Do_something_with_exclusion            |     |    |               |            Do_something_with_exclusion
'   MutexUnlock(mut) ----------------------'-----'    '---------------'----------- MutexUnlock(mut)
'   .....                                                                          .....
'
'  (connecting lines join the sender(s) and receiver(s) impacted by each action occurring during the sequence)
					</pre><tt><div class="freebasic">
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">handle</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">mutex</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">cond1</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">cond2</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">new1</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">new2</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">quit</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">Thread</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">param</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;1&quot;</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">new1</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondSignal</span><span class="oth">(</span><span class="wrd">cond1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">While</span>&nbsp;<span class="wrd">new2</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondWait</span><span class="oth">(</span><span class="wrd">cond2</span><span class="oth">,</span>&nbsp;<span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Wend</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">new2</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">quit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Exit</span>&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<br />
<span class="wrd">mutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><br />
<span class="wrd">cond1</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">CondCreate</span><br />
<span class="wrd">cond2</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">CondCreate</span><br />
<span class="wrd">handle</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">Thread</span><span class="oth">)</span><br />
<br />
<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">While</span>&nbsp;<span class="wrd">new1</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondWait</span><span class="oth">(</span><span class="wrd">cond1</span><span class="oth">,</span>&nbsp;<span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Wend</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">new1</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;0&quot;</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">new2</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondSignal</span><span class="oth">(</span><span class="wrd">cond2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="key">Inkey</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="quo">&quot;&quot;</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">quit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Exit</span>&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<span class="key">Loop</span><br />
&nbsp;<br />
<span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">handle</span><span class="oth">)</span><br />
<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
<span class="key">CondDestroy</span><span class="oth">(</span><span class="wrd">cond1</span><span class="oth">)</span><br />
<span class="key">CondDestroy</span><span class="oth">(</span><span class="wrd">cond2</span><span class="oth">)</span><br />
<span class="key">Print</span><br />
<br />
<span class="key">Sleep</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
<a name="ProPgMtCriticalSectionsFAQ4.1"></a><br \>
</div></div></div></div></div><div class="fb_sect_title">4.1. Is 'Condwait' (and 'Condsignal' or 'Condbroadcast') still useful when there is already a 'While...Wend' loop for checking a Boolean predicate set by other thread?</div><div class="fb_sect_cont"><br \>
<div class="fb_indent"><tt><i>(another question induced by the previous one)</i></tt><br \>
<div class="fb_indent"><b>-</b> The recommended structure is as follows:<br \>
<div class="fb_indent"><pre class="fb_pre">
'  Principle of mutual exclusion + CONDWAIT in a While...Wend loop with predicate check, for a thread sub-section
'  (connecting lines join the sender(s) and receiver(s) impacted by each action occurring during the sequence)
'
'
'          Thread                                        Other Thread
'      MUTEXLOCK(mutexID) <------------------------- from ( atomic_mutex_unlock(mutexID) ) or MUTEXUNLOCK(mutexID)
'      .......
'      While booleanT <> True <--------------------- from booleanT = True
'          ( atomic_mutex_unlock(mutexID) ) -------> to MUTEXLOCK(mutexID) or ( atomic_mutex_re-lock(mutexID) )
'          CONDWAIT(conditionalID, mutexID) <------- from CONDSIGNAL(conditionalID)
'          ( atomic_mutex_re-lock(mutexID) ) <------ from ( atomic_mutex_unlock(mutexID) ) or MUTEXUNLOCK(mutexID)
'      Wend
'      booleanT = False
'      .......
'      MUTEXUNLOCK(mutexID) -----------------------> to MUTEXLOCK(mutexID) or ( atomic_mutex_re-lock(mutexID) )
				</pre><pre class="fb_pre">
'  Principle of mutual exclusion + CONDSIGNAL with predicate check, for a thread sub-section
'  (connecting lines join the sender(s) and receiver(s) impacted by each action occurring during the sequence)
'
'          Thread                                        Other Thread
'      MUTEXLOCK(mutexID) <------------------------- from ( atomic_mutex_unlock(mutexID) ) or MUTEXUNLOCK(mutexID)
'      .......
'      booleanOT = True ---------------------------> to While booleanOT <> True
'      CONDSIGNAL(conditionalID) ------------------> to CONDWAIT(conditionalID, mutexID)
'      .......
'      MUTEXUNLOCK(mutexID) -----------------------> to MUTEXLOCK(mutexID) or ( atomic_mutex_re-lock(mutexID) )
				</pre></div><b>-</b> If 'CondWait' is not used, it is mandatory to put instead a 'Sleep x, 1' instruction in the 'While...Wend' loop on the Boolean flag, in order to release time-slice when looping (in addition, this 'Sleep x, 1' must be put inside a ['Mutexunlock'...'Mutexlock'] block to release another thread):<br \>
<div class="fb_indent"><pre class="fb_pre">
'  Principle of mutual exclusion + SLEEP in a While...Wend loop with predicate check, for a thread sub-section
'  (connecting lines join the sender(s) and receiver(s) impacted by each action occurring during the sequence)
'
'          Thread                                        Other Thread
'      MUTEXLOCK(mutexID) <------------------------- from MUTEXUNLOCK(mutexID)
'      .......
'      While booleanT <> True <--------------------- from booleanT = True
'          MUTEXUNLOCK(mutexID) -------------------> to MUTEXLOCK(mutexID)
'          SLEEP(tempo, 1)
'          MUTEXLOCK(mutexID) <--------------------- from MUTEXUNLOCK(mutexID)
'      Wend
'      booleanT = False
'      .......
'      MUTEXUNLOCK(mutexID) -----------------------> to MUTEXLOCK(mutexID)
				</pre><pre class="fb_pre">
'  Principle of mutual exclusion + predicate check only, for a thread sub-section
'  (connecting lines join the sender(s) and receiver(s) impacted by each action occurring during the sequence)
'
'          Thread                                        Other Thread
'      MUTEXLOCK(mutexID) <------------------------- from MUTEXUNLOCK(mutexID)
'      .......
'      booleanOT = True ---------------------------> to While booleanOT <> True
'      .......
'      MUTEXUNLOCK(mutexID) -----------------------> to MUTEXLOCK(mutexID)
				</pre></div>During 'CondWait', the thread execution is suspended and does not consume any CPU time until the condition variable is signaled.<br \>
But if 'Sleep x, 1' is put instead, the waiting time is predetermined and not self adaptive like that of 'CondWait'.<br \>
<br \>
<b>=&gt;</b> 'CondWait' is useful to optimize the execution time.<br \>
<br \>
</div></div><div style="text-align: center;"><a href="#ProPgMtCriticalSectionsFAQtop">Back to top</a></div><br \>
<a name="ProPgMtCriticalSectionsFAQ5"></a><br \>
</div><div class="fb_sect_title">5. How to implement a user input-line function fully thread-safe?</div><div class="fb_sect_cont"><br \>
<div class="fb_indent">The <tt><i>Input</i></tt> keyword may be not thread-safe, when another thread must also access to input/output resource:<br \>
<div class="fb_indent"><b>-</b> When executing the <tt><i>Input</i></tt> statement, the other running threads must not change the position of the text cursor, which prohibits instructions such as <tt><i>Locate</i></tt>, <tt><i>Print</i></tt>, ...<br \>
<b>-</b> Moreover, one cannot enclosed the <tt><i>Input</i></tt> keyword inside a mutex locking (as we can do it for the <tt><i>Inkey</i></tt> keyword), because while the inputting line would be not completed and validated, the other threads that want to also access to input/output would be fully blocked (waiting for mutex unlocking).<br \>
<br \>
</div>Thread-safe input-line function (versus input/output resource):<br \>
<div class="fb_indent">Input position, prompt message, sleeping time, line-blanking command, mutex pointer can be passed to the following <tt><i>threadInput()</i></tt> function that simulates a simplified input function, but thread-safe, by using a looping around the <tt><i>Inkey</i></tt> keyword (all input/output keywords must be enclosed inside a mutex locking block, and the cursor position must be restored at each mutex locking block ending):<br \>
<div class="fb_indent"><tt><div class="freebasic">
<span class="key">Function</span>&nbsp;<span class="wrd">threadInput</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">row</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">column</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="key">ByRef</span>&nbsp;<span class="wrd">prompt</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;&quot;</span><span class="oth">,</span>&nbsp;<span class="wrd">_</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">sleeptime</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">15</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">blank</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">mutex</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="wrd">_</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">inputchr</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">inputline</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">cursor</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">cursor0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">r</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">c</span><br />
<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">r</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">CsrLin</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">c</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Pos</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="wrd">row</span><span class="oth">,</span>&nbsp;<span class="wrd">column</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="wrd">prompt</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="quo">&quot;&nbsp;_&quot;</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">cursor0</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Pos</span><span class="oth">()</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="wrd">r</span><span class="oth">,</span>&nbsp;<span class="wrd">c</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">r</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">CsrLin</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">c</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Pos</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Inkey</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="quo">&quot;&quot;</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">&gt;=</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">32</span><span class="oth">)</span>&nbsp;<span class="key">And</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">&lt;</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">255</span><span class="oth">)</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">inputline</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Left</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="key">Mid</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">cursor</span>&nbsp;<span class="oth">+=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ElseIf</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">08</span><span class="oth">)</span>&nbsp;<span class="key">And</span>&nbsp;<span class="wrd">Cursor</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'BkSp</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">cursor</span>&nbsp;<span class="oth">-=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">inputline</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Left</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="key">Mid</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ElseIf</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">255</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="quo">&quot;S&quot;</span>&nbsp;<span class="key">And</span>&nbsp;<span class="wrd">Cursor</span>&nbsp;<span class="oth">&lt;</span>&nbsp;<span class="key">Len</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">)</span>&nbsp;<span class="key">Then</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'Del</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">inputline</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Left</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="key">Mid</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ElseIf</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">255</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="quo">&quot;M&quot;</span>&nbsp;<span class="key">And</span>&nbsp;<span class="wrd">Cursor</span>&nbsp;<span class="oth">&lt;</span>&nbsp;<span class="key">Len</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">)</span>&nbsp;<span class="key">Then</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'Right</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">Cursor</span>&nbsp;<span class="oth">+=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ElseIf</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">255</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="quo">&quot;K&quot;</span>&nbsp;<span class="key">And</span>&nbsp;<span class="wrd">Cursor</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'Left</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">Cursor</span>&nbsp;<span class="oth">-=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">27</span><span class="oth">)</span>&nbsp;<span class="key">Then</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'Esc</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="wrd">row</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="key">Space</span><span class="oth">(</span><span class="key">Len</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">);</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">inputline</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;&quot;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">cursor</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="wrd">row</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="key">Left</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">95</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="key">Mid</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="quo">&quot;&nbsp;&quot;</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="wrd">r</span><span class="oth">,</span>&nbsp;<span class="wrd">c</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="wrd">sleeptime</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">13</span><span class="oth">)</span><br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">blank</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">r</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">CsrLin</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">c</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Pos</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="wrd">row</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="key">Space</span><span class="oth">(</span><span class="key">Len</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">);</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="wrd">r</span><span class="oth">,</span>&nbsp;<span class="wrd">c</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="wrd">inputline</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
</div></div></div><ul><ul><ul><li> From the example 1 on the <tt><a href="ProPgMtCriticalSections.html">Critical Sections</a></tt> page "Asynchronous method example using a mutex for all threads", now the running multi-threading code is waiting for the "quit" command in order to exit the program:<br \>
</ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><pre class="fb_pre">
'   User thread algorithm:
'
'     Do
'     |  Mutexlock
'     |  .....
'     |  Critical section of code
'     |  .....
'     |  Mutexunlock
'     |  Sleep my_tempo, 1
'     Loop Until quit = true
'
'   There is no any advantage or disadvantage between threads for running their critical sections.
					</pre><tt><div class="freebasic">
<span class="key">Function</span>&nbsp;<span class="wrd">threadInput</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">row</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">column</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="key">ByRef</span>&nbsp;<span class="wrd">prompt</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;&quot;</span><span class="oth">,</span>&nbsp;<span class="wrd">_</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">sleeptime</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">15</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">blank</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">mutex</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="wrd">_</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">inputchr</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">inputline</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">cursor</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">cursor0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">r</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">c</span><br />
<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">r</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">CsrLin</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">c</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Pos</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="wrd">row</span><span class="oth">,</span>&nbsp;<span class="wrd">column</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="wrd">prompt</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="quo">&quot;&nbsp;_&quot;</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">cursor0</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Pos</span><span class="oth">()</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="wrd">r</span><span class="oth">,</span>&nbsp;<span class="wrd">c</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">r</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">CsrLin</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">c</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Pos</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Inkey</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="quo">&quot;&quot;</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">&gt;=</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">32</span><span class="oth">)</span>&nbsp;<span class="key">And</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">&lt;</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">255</span><span class="oth">)</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">inputline</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Left</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="key">Mid</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">cursor</span>&nbsp;<span class="oth">+=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ElseIf</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">08</span><span class="oth">)</span>&nbsp;<span class="key">And</span>&nbsp;<span class="wrd">Cursor</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'BkSp</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">cursor</span>&nbsp;<span class="oth">-=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">inputline</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Left</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="key">Mid</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ElseIf</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">255</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="quo">&quot;S&quot;</span>&nbsp;<span class="key">And</span>&nbsp;<span class="wrd">Cursor</span>&nbsp;<span class="oth">&lt;</span>&nbsp;<span class="key">Len</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">)</span>&nbsp;<span class="key">Then</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'Del</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">inputline</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Left</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="key">Mid</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ElseIf</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">255</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="quo">&quot;M&quot;</span>&nbsp;<span class="key">And</span>&nbsp;<span class="wrd">Cursor</span>&nbsp;<span class="oth">&lt;</span>&nbsp;<span class="key">Len</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">)</span>&nbsp;<span class="key">Then</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'Right</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">Cursor</span>&nbsp;<span class="oth">+=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ElseIf</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">255</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="quo">&quot;K&quot;</span>&nbsp;<span class="key">And</span>&nbsp;<span class="wrd">Cursor</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'Left</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">Cursor</span>&nbsp;<span class="oth">-=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">27</span><span class="oth">)</span>&nbsp;<span class="key">Then</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'Esc</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="wrd">row</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="key">Space</span><span class="oth">(</span><span class="key">Len</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">);</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">inputline</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;&quot;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">cursor</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="wrd">row</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="key">Left</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">95</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="key">Mid</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="quo">&quot;&nbsp;&quot;</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="wrd">r</span><span class="oth">,</span>&nbsp;<span class="wrd">c</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="wrd">sleeptime</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="wrd">inputchr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">13</span><span class="oth">)</span><br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">blank</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">r</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">CsrLin</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">c</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Pos</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="wrd">row</span><span class="oth">,</span>&nbsp;<span class="wrd">cursor0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="key">Space</span><span class="oth">(</span><span class="key">Len</span><span class="oth">(</span><span class="wrd">inputline</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">);</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="wrd">r</span><span class="oth">,</span>&nbsp;<span class="wrd">c</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="wrd">inputline</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="com">'------------------------------------------------------------------------------</span><br />
<br />
<span class="key">Type</span>&nbsp;<span class="wrd">UDT</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">number</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">tempo</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">pThread</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">ULongInt</span>&nbsp;<span class="wrd">count</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">pMutex</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">numberMax</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">quit</span><br />
<span class="key">End</span>&nbsp;<span class="key">Type</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">UDT.pMutex</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">UDT.numberMax</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">UDT.quit</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">Counter</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">pt</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">UDT</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">With</span>&nbsp;<span class="oth">*</span><span class="wrd">pt</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="oth">.</span><span class="wrd">number</span><span class="oth">,</span>&nbsp;<span class="oth">.</span><span class="wrd">number</span><span class="oth">,</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">5</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="wrd">count</span>&nbsp;<span class="oth">+=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="oth">.</span><span class="wrd">count</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">With</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">Thread</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">myquit</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">UDT</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">pUDT</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">With</span>&nbsp;<span class="oth">*</span><span class="wrd">pUDT</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(.</span><span class="wrd">pMutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">Counter</span><span class="oth">(</span><span class="wrd">pUDT</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">myquit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="oth">.</span><span class="wrd">quit</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(.</span><span class="wrd">pMutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="oth">.</span><span class="wrd">tempo</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="wrd">myquit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">With</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<br />
<span class="key">Screen</span>&nbsp;<span class="num">12</span><br />
<span class="wrd">UDT.numberMax</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">6</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">UDT</span>&nbsp;<span class="wrd">u</span><span class="oth">(</span><span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">UDT.numberMax</span><span class="oth">)</span><br />
<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">UDT.numberMax</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">u</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">).</span><span class="wrd">number</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">i</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">u</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">).</span><span class="wrd">tempo</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">100</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">15</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">95</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">Sgn</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span><br />
<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="wrd">UDT.pMutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Single</span>&nbsp;<span class="wrd">t</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Timer</span><br />
<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">UDT.numberMax</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">u</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">).</span><span class="wrd">pThread</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">Thread</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">u</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">))</span><br />
<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<br />
<span class="key">Do</span><br />
<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="key">LCase</span><span class="oth">(</span><span class="wrd">threadInput</span><span class="oth">(</span><span class="num">8</span><span class="oth">,</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="quo">&quot;&quot;&quot;quit&quot;&quot;&nbsp;for&nbsp;exit?&quot;</span><span class="oth">,</span>&nbsp;<span class="num">10</span><span class="oth">,</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="wrd">UDT.pMutex</span><span class="oth">))</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;quit&quot;</span><br />
<br />
<span class="wrd">UDT.quit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
<br />
<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">UDT.numberMax</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">u</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">).</span><span class="wrd">pThread</span><span class="oth">)</span><br />
<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="wrd">t</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Timer</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="wrd">t</span><br />
<br />
<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">UDT.pMutex</span><span class="oth">)</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">ULongInt</span>&nbsp;<span class="wrd">c</span><br />
<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">UDT.numberMax</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">c</span>&nbsp;<span class="oth">+=</span>&nbsp;<span class="wrd">u</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">).</span><span class="wrd">count</span><br />
<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="key">Locate</span>&nbsp;<span class="wrd">UDT.numberMax</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">4</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<span class="key">Print</span>&nbsp;<span class="key">CULngInt</span><span class="oth">(</span><span class="wrd">c</span>&nbsp;<span class="oth">/</span>&nbsp;<span class="wrd">t</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="quo">&quot;&nbsp;increments&nbsp;per&nbsp;second&quot;</span><br />
<br />
<span class="key">Sleep</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
</div></div></div><b>Note:</b><br \>
<div class="fb_indent">Otherwise, by using only graphics keywords (using the only position of the graphic cursor) as <tt><i>Line</i></tt>, <tt><i>Draw String</i></tt>, <tt><i>Put</i></tt> in the thread, induces a thread-safe procedure that is compatible with the <tt><i>Line Input</i></tt> keyword in the main code with no mutex:<br \>
<div class="fb_indent"><tt><div class="freebasic">
<span class="key">Type</span>&nbsp;<span class="wrd">UDT</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">number</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">tempo</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">pThread</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">ULongInt</span>&nbsp;<span class="wrd">count</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">img</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">numberMax</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">quit</span><br />
<span class="key">End</span>&nbsp;<span class="key">Type</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">UDT.numberMax</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">UDT.quit</span><br />
<br />
<span class="key">Const</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">prompt</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;Enter&nbsp;&quot;&quot;quit&quot;&quot;&nbsp;for&nbsp;exit&quot;</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">s</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">Counter</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">pt</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">UDT</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;&nbsp;<span class="com">'&nbsp;for&nbsp;a&nbsp;graphic&nbsp;character&nbsp;size&nbsp;8x16</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">With</span>&nbsp;<span class="oth">*</span><span class="wrd">pt</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Line</span>&nbsp;<span class="oth">.</span><span class="wrd">img</span><span class="oth">,</span>&nbsp;<span class="oth">(</span><span class="num">0</span><span class="oth">,</span>&nbsp;<span class="num">0</span><span class="oth">)-(</span><span class="num">20</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="num">8</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">16</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><span class="oth">),</span>&nbsp;<span class="num">0</span><span class="oth">,</span>&nbsp;<span class="wrd">BF</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'&nbsp;clearing&nbsp;the&nbsp;image&nbsp;buffer</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">5</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="wrd">count</span>&nbsp;<span class="oth">+=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Draw</span>&nbsp;<span class="key">String</span>&nbsp;<span class="oth">.</span><span class="wrd">img</span><span class="oth">,</span>&nbsp;<span class="oth">(</span><span class="num">0</span><span class="oth">,</span>&nbsp;<span class="num">0</span><span class="oth">),</span>&nbsp;<span class="key">Str</span><span class="oth">(.</span><span class="wrd">count</span><span class="oth">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'&nbsp;drawing&nbsp;in&nbsp;the&nbsp;image&nbsp;buffer</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Put</span>&nbsp;<span class="oth">((.</span><span class="wrd">number</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><span class="oth">)</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="num">8</span><span class="oth">,</span>&nbsp;<span class="oth">(.</span><span class="wrd">number</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><span class="oth">)</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="num">16</span><span class="oth">),</span>&nbsp;<span class="oth">.</span><span class="wrd">img</span><span class="oth">,</span>&nbsp;<span class="key">PSet</span>&nbsp;&nbsp;<span class="com">'&nbsp;copying&nbsp;the&nbsp;image&nbsp;buffer&nbsp;to&nbsp;screen</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">With</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">Thread</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'&nbsp;for&nbsp;a&nbsp;graphic&nbsp;character&nbsp;size&nbsp;8x16</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">UDT</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">pUDT</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">With</span>&nbsp;<span class="oth">*</span><span class="wrd">pUDT</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="wrd">img</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ImageCreate</span><span class="oth">(</span><span class="num">20</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="num">8</span><span class="oth">,</span>&nbsp;<span class="num">16</span><span class="oth">)</span>&nbsp;&nbsp;<span class="com">'&nbsp;using&nbsp;an&nbsp;image&nbsp;buffer&nbsp;to&nbsp;avoid&nbsp;flickering</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">Counter</span><span class="oth">(</span><span class="wrd">pUDT</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="oth">.</span><span class="wrd">tempo</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="oth">.</span><span class="wrd">quit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ImageDestroy</span>&nbsp;<span class="oth">.</span><span class="wrd">img</span>&nbsp;&nbsp;<span class="com">'&nbsp;destroying&nbsp;the&nbsp;image&nbsp;buffer</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">With</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<br />
<span class="key">Screen</span>&nbsp;<span class="num">12</span><br />
<span class="wrd">UDT.numberMax</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">6</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">UDT</span>&nbsp;<span class="wrd">u</span><span class="oth">(</span><span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">UDT.numberMax</span><span class="oth">)</span><br />
<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">UDT.numberMax</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">u</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">).</span><span class="wrd">number</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">i</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">u</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">).</span><span class="wrd">tempo</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">100</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">15</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">95</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">Sgn</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span><br />
<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Single</span>&nbsp;<span class="wrd">t</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Timer</span><br />
<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">UDT.numberMax</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">u</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">).</span><span class="wrd">pThread</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">Thread</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">u</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">))</span><br />
<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<br />
<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="num">8</span><span class="oth">,</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Line</span>&nbsp;<span class="key">Input</span><span class="oth">;</span>&nbsp;<span class="wrd">prompt</span><span class="oth">;</span>&nbsp;<span class="wrd">s</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="oth">,</span>&nbsp;<span class="key">Len</span><span class="oth">(</span><span class="wrd">prompt</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">3</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="key">Space</span><span class="oth">(</span><span class="key">Len</span><span class="oth">(</span><span class="wrd">s</span><span class="oth">));</span><br />
<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="key">LCase</span><span class="oth">(</span><span class="wrd">s</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;quit&quot;</span><br />
<span class="wrd">UDT.quit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
<br />
<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">UDT.numberMax</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">u</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">).</span><span class="wrd">pThread</span><span class="oth">)</span><br />
<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="wrd">t</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Timer</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="wrd">t</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">ULongInt</span>&nbsp;<span class="wrd">c</span><br />
<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">UDT.numberMax</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">c</span>&nbsp;<span class="oth">+=</span>&nbsp;<span class="wrd">u</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">).</span><span class="wrd">count</span><br />
<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="key">Locate</span>&nbsp;<span class="wrd">UDT.numberMax</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">4</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<span class="key">Print</span>&nbsp;<span class="key">CULngInt</span><span class="oth">(</span><span class="wrd">c</span>&nbsp;<span class="oth">/</span>&nbsp;<span class="wrd">t</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="quo">&quot;&nbsp;increments&nbsp;per&nbsp;second&quot;</span><br />
<br />
<span class="key">Sleep</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
</div></div></div><div style="text-align: center;"><a href="#ProPgMtCriticalSectionsFAQtop">Back to top</a></div><br \>
<a name="ProPgMtCriticalSectionsFAQ6"></a><br \>
</div><div class="fb_sect_title">6. How to use 'Screenlock' with multi-threading?</div><div class="fb_sect_cont"><br \>
<div class="fb_indent"><b>-</b> <tt><i>Screenlock...Scrennunlock</i></tt> blocks are not compatible with multi-threading (otherwise, the program hangs). This is why a mutex block must be used around each such block to ensure the mutual exclusion.<br \>
<b>-</b> The input keywords (like for keyboard, mouse) cannot be safely run when the screen is locked, therefore a such keyword must be outside of any <tt><i>Screenlock...Screenunlock</i></tt> block, so outside any <tt><i>Screenlock...Screenunlock</i></tt> block in its own thread, and protected of all <tt><i>Screenlock...Screenunlock</i></tt> blocks of other threads by a mutex block. Therefore, <tt><i>Getkey</i></tt> and <tt><i>Input</i></tt>, the statements that wait for keypress or line input are unusable, but <tt><i>Inkey</i></tt> that does not wait can work.<br \>
<br \>
By applying some rules scrupulously, one can use <tt><i>Screenlock</i></tt>/<tt><i>Screenunlock</i></tt> inside the threads.<br \>
Principle of coding for all threads including the main code (main thread):<br \>
<div class="fb_indent"><pre class="fb_pre">
Do
	' instructions without display (printing/drawing, ...) neither input (input/inkey/mouse getting, ...)
	MutexLock(m)
	Screenlock
	' instructions with only display (printing/drawing, ...)
	Screenunlock
	' instructions with only input without waiting (inkey/mouse getting, ...)
	MutexUnlock(m)
	Sleep tempo, 1
Loop Until condition
			</pre></div></div><ul><ul><li> For example, it is mandatory to use one <tt><i>Mutexlock...Mutexunlock</i></tt> block around each <tt><i>Screenlock...Screenunlock</i></tt> block, and one other around the <tt><i>Inkey</i></tt> instruction which itself must always be outside of any <tt><i>Screenlock...Screenunlock</i></tt> bloc:<br \>
</ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><tt><div class="freebasic">
<span class="key">Type</span>&nbsp;<span class="wrd">ThreadUDT</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="wrd">handle</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="wrd">sync</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="wrd">quit</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Byte</span><br />
<span class="key">End</span>&nbsp;<span class="key">Type</span><br />
<span class="key">Dim</span>&nbsp;<span class="wrd">ThreadUDT.sync</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><br />
<span class="key">Dim</span>&nbsp;<span class="wrd">ThreadUDT.quit</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Byte</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">ClockTime</span>&nbsp;<span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="key">Time</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">Counter</span>&nbsp;<span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="wrd">C</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">C</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="oth">(</span><span class="wrd">C</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span>&nbsp;<span class="key">Mod</span>&nbsp;<span class="num">1000000</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="wrd">C</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ProcedureThread</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">param</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">With</span>&nbsp;<span class="oth">*</span><span class="key">Cast</span><span class="oth">(</span><span class="wrd">ThreadUDT</span>&nbsp;<span class="key">Ptr</span><span class="oth">,</span>&nbsp;<span class="wrd">param</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(.</span><span class="wrd">sync</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenLock</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Line</span>&nbsp;<span class="oth">(</span><span class="num">544</span><span class="oth">,</span>&nbsp;<span class="num">0</span><span class="oth">)-(</span><span class="num">639</span><span class="oth">,</span>&nbsp;<span class="num">49</span><span class="oth">),</span>&nbsp;<span class="num">0</span><span class="oth">,</span>&nbsp;<span class="wrd">BF</span>&nbsp;&nbsp;<span class="com">'clear&nbsp;the&nbsp;print&nbsp;area</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="num">2</span><span class="oth">,</span>&nbsp;<span class="num">71</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="wrd">ClockTime</span><span class="oth">();</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenUnlock</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(.</span><span class="wrd">sync</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="oth">.</span><span class="wrd">quit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">With</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Screen</span>&nbsp;<span class="num">12</span><br />
<span class="key">Locate</span>&nbsp;<span class="num">30</span><span class="oth">,</span>&nbsp;<span class="num">2</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&lt;q/Q&gt;&nbsp;:&nbsp;quit&quot;</span><span class="oth">;</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="wrd">TTptr</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">ThreadUDT</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">New</span>&nbsp;<span class="wrd">ThreadUDT</span><br />
<span class="wrd">ThreadUDT.sync</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><br />
<span class="wrd">TTptr</span><span class="oth">-&gt;</span><span class="wrd">handle</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">ProcedureThread</span><span class="oth">,</span>&nbsp;<span class="wrd">TTptr</span><span class="oth">)</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">s</span><br />
<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">ThreadUDT.sync</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenLock</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Line</span>&nbsp;<span class="oth">(</span><span class="num">296</span><span class="oth">,</span>&nbsp;<span class="num">208</span><span class="oth">)-(</span><span class="num">376</span><span class="oth">,</span>&nbsp;<span class="num">256</span><span class="oth">),</span>&nbsp;<span class="num">0</span><span class="oth">,</span>&nbsp;<span class="wrd">BF</span>&nbsp;&nbsp;<span class="com">'clear&nbsp;the&nbsp;print&nbsp;area</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="num">15</span><span class="oth">,</span><span class="num">40</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="key">Using</span>&nbsp;<span class="quo">&quot;######&quot;</span><span class="oth">;</span>&nbsp;<span class="wrd">Counter</span><span class="oth">();</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenUnlock</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">s</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Inkey</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">ThreadUDT.sync</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="key">LCase</span><span class="oth">(</span><span class="wrd">s</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;q&quot;</span><br />
&nbsp;<br />
<span class="wrd">ThreadUDT.quit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
<span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">TTptr</span><span class="oth">-&gt;</span><span class="wrd">handle</span><span class="oth">)</span><br />
<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">ThreadUDT.sync</span><span class="oth">)</span><br />
<span class="key">Delete</span>&nbsp;<span class="wrd">TTptr</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
Note: The <tt><i>Sleep x, 1</i></tt> keyword just after the 'clear the print area' lines is only here to highlight the flickering if no screen locking is used.<br \>
<br \>
</div></div></div><div style="text-align: center;"><a href="#ProPgMtCriticalSectionsFAQtop">Back to top</a></div><br \>
<a name="ProPgMtCriticalSectionsFAQ7"></a><br \>
</div><div class="fb_sect_title">7. How to use 'video paging (double buffering or page flipping)' with multi-threading?</div><div class="fb_sect_cont"><br \>
<div class="fb_indent">Instead of "screen locking" (see the above paragraph), "video paging (double buffering or page flipping)" can more simply be used with multi-threading, but be careful that many states in the gfxlib2 are thread-dependent like <tt><i>Screenset</i></tt> (and also <tt><i>View</i></tt> settings, graphic cursor position, graphic colors, ...).<br \>
Therefore, the setting for the working page and the visible page must always be controlled in each thread code which want to work with a multi-video page configuration.<br \>
<br \>
</div><ul><ul><li> Example for a double buffering method (at each step, each thread needs to update the working page and copy it to the visible page, from within a mutual exclusion mutex code block):<br \>
</ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><tt><div class="freebasic">
<span class="key">Type</span>&nbsp;<span class="wrd">ThreadUDT</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="wrd">handle</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="wrd">sync</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="wrd">quit</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Byte</span><br />
<span class="key">End</span>&nbsp;<span class="key">Type</span><br />
<span class="key">Dim</span>&nbsp;<span class="wrd">ThreadUDT.sync</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><br />
<span class="key">Dim</span>&nbsp;<span class="wrd">ThreadUDT.quit</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Byte</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">ClockTime</span>&nbsp;<span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="key">Time</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">Counter</span>&nbsp;<span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="wrd">C</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">C</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="oth">(</span><span class="wrd">C</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span>&nbsp;<span class="key">Mod</span>&nbsp;<span class="num">1000000</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="wrd">C</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ProcedureThread</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">param</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenSet</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">0</span>&nbsp;&nbsp;<span class="com">''&nbsp;setting&nbsp;to&nbsp;define&nbsp;in&nbsp;each&nbsp;thread</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">With</span>&nbsp;<span class="oth">*</span><span class="key">Cast</span><span class="oth">(</span><span class="wrd">ThreadUDT</span>&nbsp;<span class="key">Ptr</span><span class="oth">,</span>&nbsp;<span class="wrd">param</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(.</span><span class="wrd">sync</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Line</span>&nbsp;<span class="oth">(</span><span class="num">544</span><span class="oth">,</span>&nbsp;<span class="num">0</span><span class="oth">)-(</span><span class="num">639</span><span class="oth">,</span>&nbsp;<span class="num">49</span><span class="oth">),</span>&nbsp;<span class="num">0</span><span class="oth">,</span>&nbsp;<span class="wrd">BF</span>&nbsp;&nbsp;<span class="com">''&nbsp;clear&nbsp;the&nbsp;print&nbsp;area</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="num">2</span><span class="oth">,</span>&nbsp;<span class="num">71</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="wrd">ClockTime</span><span class="oth">();</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenCopy</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(.</span><span class="wrd">sync</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="oth">.</span><span class="wrd">quit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">With</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Screen</span>&nbsp;<span class="num">12</span><span class="oth">,</span>&nbsp;<span class="oth">,</span>&nbsp;<span class="num">2</span><br />
<span class="key">ScreenSet</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">0</span>&nbsp;&nbsp;<span class="com">''&nbsp;setting&nbsp;to&nbsp;define&nbsp;in&nbsp;each&nbsp;thread</span><br />
<span class="key">Locate</span>&nbsp;<span class="num">30</span><span class="oth">,</span>&nbsp;<span class="num">2</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&lt;q/Q&gt;&nbsp;:&nbsp;quit&quot;</span><span class="oth">;</span><br />
<span class="key">ScreenCopy</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="wrd">TTptr</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">ThreadUDT</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">New</span>&nbsp;<span class="wrd">ThreadUDT</span><br />
<span class="wrd">ThreadUDT.sync</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><br />
<span class="wrd">TTptr</span><span class="oth">-&gt;</span><span class="wrd">handle</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">ProcedureThread</span><span class="oth">,</span>&nbsp;<span class="wrd">TTptr</span><span class="oth">)</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="wrd">s</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">ThreadUDT.sync</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Line</span>&nbsp;<span class="oth">(</span><span class="num">296</span><span class="oth">,</span>&nbsp;<span class="num">208</span><span class="oth">)-(</span><span class="num">376</span><span class="oth">,</span>&nbsp;<span class="num">256</span><span class="oth">),</span>&nbsp;<span class="num">0</span><span class="oth">,</span>&nbsp;<span class="wrd">BF</span>&nbsp;&nbsp;<span class="com">''&nbsp;clear&nbsp;the&nbsp;print&nbsp;area</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="num">15</span><span class="oth">,</span><span class="num">40</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="key">Using</span>&nbsp;<span class="quo">&quot;######&quot;</span><span class="oth">;</span>&nbsp;<span class="wrd">Counter</span><span class="oth">();</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenCopy</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">s</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Inkey</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">ThreadUDT.sync</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="key">LCase</span><span class="oth">(</span><span class="wrd">s</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;q&quot;</span><br />
&nbsp;<br />
<span class="wrd">ThreadUDT.quit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
<span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">TTptr</span><span class="oth">-&gt;</span><span class="wrd">handle</span><span class="oth">)</span><br />
<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">ThreadUDT.sync</span><span class="oth">)</span><br />
<span class="key">Delete</span>&nbsp;<span class="wrd">TTptr</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
Note: The <tt><i>Sleep x, 1</i></tt> keyword just after the 'clear the print area' lines is only here to highlight the flickering if no double buffering is used.<br \>
<br \>
</div></div></div><ul><ul><li> Example for a two page flipping method (at each step, each thread needs to update and flip, from within the same exclusion mutex code block, the two screen pages):<br \>
</ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><tt><div class="freebasic">
<span class="key">Type</span>&nbsp;<span class="wrd">ThreadUDT</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="wrd">handle</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="wrd">sync</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="wrd">quit</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Byte</span><br />
<span class="key">End</span>&nbsp;<span class="key">Type</span><br />
<span class="key">Dim</span>&nbsp;<span class="wrd">ThreadUDT.sync</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><br />
<span class="key">Dim</span>&nbsp;<span class="wrd">ThreadUDT.quit</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Byte</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">ClockTime</span>&nbsp;<span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="key">Time</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">Counter</span>&nbsp;<span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="wrd">C</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">C</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="oth">(</span><span class="wrd">C</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span>&nbsp;<span class="key">Mod</span>&nbsp;<span class="num">1000000</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="wrd">C</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ProcedureThread</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">param</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="wrd">p0</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="wrd">p1</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenSet</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">0</span>&nbsp;&nbsp;<span class="com">''&nbsp;setting&nbsp;to&nbsp;define&nbsp;in&nbsp;each&nbsp;thread</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">With</span>&nbsp;<span class="oth">*</span><span class="key">Cast</span><span class="oth">(</span><span class="wrd">ThreadUDT</span>&nbsp;<span class="key">Ptr</span><span class="oth">,</span>&nbsp;<span class="wrd">param</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(.</span><span class="wrd">sync</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="wrd">s</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">ClockTime</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">2</span>&nbsp;&nbsp;<span class="com">''&nbsp;updating&nbsp;the&nbsp;two&nbsp;screen&nbsp;pages</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Line</span>&nbsp;<span class="oth">(</span><span class="num">544</span><span class="oth">,</span>&nbsp;<span class="num">0</span><span class="oth">)-(</span><span class="num">639</span><span class="oth">,</span>&nbsp;<span class="num">49</span><span class="oth">),</span>&nbsp;<span class="num">0</span><span class="oth">,</span>&nbsp;<span class="wrd">BF</span>&nbsp;&nbsp;<span class="com">''&nbsp;clear&nbsp;the&nbsp;print&nbsp;area</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="num">2</span><span class="oth">,</span>&nbsp;<span class="num">71</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="wrd">s</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenSet</span>&nbsp;<span class="wrd">p0</span><span class="oth">,</span>&nbsp;<span class="wrd">p1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Swap</span>&nbsp;<span class="wrd">p0</span><span class="oth">,</span>&nbsp;<span class="wrd">p1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(.</span><span class="wrd">sync</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="oth">.</span><span class="wrd">quit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">With</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Screen</span>&nbsp;<span class="num">12</span><span class="oth">,</span>&nbsp;<span class="oth">,</span>&nbsp;<span class="num">2</span><br />
<span class="key">Dim</span>&nbsp;<span class="wrd">p0</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
<span class="key">Dim</span>&nbsp;<span class="wrd">p1</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
<span class="key">ScreenSet</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">0</span>&nbsp;&nbsp;<span class="com">''&nbsp;setting&nbsp;to&nbsp;define&nbsp;in&nbsp;each&nbsp;thread</span><br />
<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">2</span>&nbsp;&nbsp;<span class="com">''&nbsp;updating&nbsp;the&nbsp;two&nbsp;screen&nbsp;pages</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="num">30</span><span class="oth">,</span>&nbsp;<span class="num">2</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;&lt;q/Q&gt;&nbsp;:&nbsp;quit&quot;</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenSet</span>&nbsp;<span class="wrd">p0</span><span class="oth">,</span>&nbsp;<span class="wrd">p1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Swap</span>&nbsp;<span class="wrd">p0</span><span class="oth">,</span>&nbsp;<span class="wrd">p1</span><br />
<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="wrd">TTptr</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">ThreadUDT</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">New</span>&nbsp;<span class="wrd">ThreadUDT</span><br />
<span class="wrd">ThreadUDT.sync</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><br />
<span class="wrd">TTptr</span><span class="oth">-&gt;</span><span class="wrd">handle</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">ProcedureThread</span><span class="oth">,</span>&nbsp;<span class="wrd">TTptr</span><span class="oth">)</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="wrd">s</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">ThreadUDT.sync</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="wrd">C</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">Counter</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">2</span>&nbsp;&nbsp;<span class="com">''&nbsp;updating&nbsp;the&nbsp;two&nbsp;screen&nbsp;pages</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Line</span>&nbsp;<span class="oth">(</span><span class="num">296</span><span class="oth">,</span>&nbsp;<span class="num">208</span><span class="oth">)-(</span><span class="num">376</span><span class="oth">,</span>&nbsp;<span class="num">256</span><span class="oth">),</span>&nbsp;<span class="num">0</span><span class="oth">,</span>&nbsp;<span class="wrd">BF</span>&nbsp;&nbsp;<span class="com">''&nbsp;clear&nbsp;the&nbsp;print&nbsp;area</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="num">15</span><span class="oth">,</span><span class="num">40</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="key">Using</span>&nbsp;<span class="quo">&quot;######&quot;</span><span class="oth">;</span>&nbsp;<span class="wrd">c</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenSet</span>&nbsp;<span class="wrd">p0</span><span class="oth">,</span>&nbsp;<span class="wrd">p1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Swap</span>&nbsp;<span class="wrd">p0</span><span class="oth">,</span>&nbsp;<span class="wrd">p1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">s</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Inkey</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">ThreadUDT.sync</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="key">LCase</span><span class="oth">(</span><span class="wrd">s</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;q&quot;</span><br />
&nbsp;<br />
<span class="wrd">ThreadUDT.quit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
<span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">TTptr</span><span class="oth">-&gt;</span><span class="wrd">handle</span><span class="oth">)</span><br />
<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">ThreadUDT.sync</span><span class="oth">)</span><br />
<span class="key">Delete</span>&nbsp;<span class="wrd">TTptr</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
Note: The <tt><i>Sleep x, 1</i></tt> keyword just after the 'clear the print area' lines is only here to highlight the flickering if no two page flipping is used.<br \>
<br \>
</div></div><b>Note:</b> In these two examples, a mutual exclusion mutex code block is mandatory in the two threads, not only because of using console statements + <tt><i>Inkey</i></tt>, but around also the graphics statements + <tt><i>Screencopy</i></tt> only because of using double buffering method (without anti-flickering process, the graphics statements could be outside the exclusion mutex code block).<br \>
<br \>
</div><div style="text-align: center;"><a href="#ProPgMtCriticalSectionsFAQtop">Back to top</a></div><br \>
<a name="ProPgMtCriticalSectionsFAQ8"></a><br \>
</div><div class="fb_sect_title">8. How to use the FB runtime library for multi-threaded applications (gfxlib2) with multi-threading?</div><div class="fb_sect_cont"><br \>
<div class="fb_indent">The source code of gfxlib2 uses TLS (Thread Local Storage) to store many states, so many things are thread-specific.<br \>
Since gfxlib2 is thread-safe, mutual mutex exclusion between threads is not necessary for the graphics statements themselves (including <tt><i>Draw String</i></tt>).<br \>
In contrast, console statements such as <tt><i>Locate</i></tt>, <tt><i>Print</i></tt>, ... are not thread-safe as previously mentioned (for example, text cursor position is common to all threads).<br \>
<br \>
</div><ul><ul><li> Simple example showing that graphic states (such as graphic cursor position, graphic colors) are thread-dependent:<br \>
</ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><tt><div class="freebasic">
<span class="key">Screen</span>&nbsp;<span class="num">12</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">thread</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Color</span>&nbsp;<span class="num">10</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">PSet</span><span class="oth">(</span><span class="num">150</span><span class="oth">,</span>&nbsp;<span class="num">10</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">40</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Line</span>&nbsp;<span class="oth">-</span><span class="key">Step</span><span class="oth">(</span><span class="num">10</span><span class="oth">,</span>&nbsp;<span class="num">10</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">150</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Draw</span>&nbsp;<span class="key">String</span>&nbsp;<span class="key">Step</span>&nbsp;<span class="oth">(-</span><span class="num">40</span><span class="oth">,</span>&nbsp;<span class="num">10</span><span class="oth">),</span>&nbsp;<span class="quo">&quot;user&nbsp;thread&quot;</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">thread</span><span class="oth">)</span><br />
<br />
<span class="key">Color</span>&nbsp;<span class="num">14</span><br />
<span class="key">PSet</span><span class="oth">(</span><span class="num">10</span><span class="oth">,</span>&nbsp;<span class="num">100</span><span class="oth">)</span><br />
<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">24</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Line</span>&nbsp;<span class="oth">-</span><span class="key">Step</span><span class="oth">(</span><span class="num">10</span><span class="oth">,</span>&nbsp;<span class="num">10</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">250</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="key">Draw</span>&nbsp;<span class="key">String</span>&nbsp;<span class="key">Step</span>&nbsp;<span class="oth">(-</span><span class="num">40</span><span class="oth">,</span>&nbsp;<span class="num">10</span><span class="oth">),</span>&nbsp;<span class="quo">&quot;main&nbsp;thread&quot;</span><br />
<br />
<span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">p</span><span class="oth">)</span><br />
<br />
<span class="key">Color</span>&nbsp;<span class="num">15</span><br />
<span class="key">Locate</span>&nbsp;<span class="num">4</span><span class="oth">,</span>&nbsp;<span class="num">2</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;Any&nbsp;key&nbsp;for&nbsp;exit&quot;</span><br />
<br />
<span class="key">Sleep</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
</div></div></div><ul><ul><li> Example showing that graphics statements (such as Line and Draw String and Screencopy) in a thread can compete with console statements (such as Inkey) in another thread, without using any exclusion (by mutex):<br \>
</ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><tt><div class="freebasic">
<span class="def">#include&nbsp;&quot;vbcompat.bi&quot;<br />
</span><br />
<span class="key">Screen</span>&nbsp;<span class="num">12</span><span class="oth">,</span>&nbsp;<span class="oth">,</span>&nbsp;<span class="num">2</span><br />
<span class="key">ScreenSet</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">0</span>&nbsp;&nbsp;&nbsp;<br />
<span class="key">Color</span>&nbsp;<span class="num">0</span><span class="oth">,</span>&nbsp;<span class="num">7</span><br />
<span class="key">Cls</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="wrd">terminate</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">thread</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">param</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenSet</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Line</span>&nbsp;<span class="oth">(</span><span class="num">16</span><span class="oth">,</span>&nbsp;<span class="num">432</span><span class="oth">)-</span><span class="key">Step</span><span class="oth">(</span><span class="num">96</span><span class="oth">,</span>&nbsp;<span class="num">32</span><span class="oth">),</span>&nbsp;<span class="num">11</span><span class="oth">,</span>&nbsp;<span class="wrd">BF</span>&nbsp;&nbsp;<span class="com">'clear&nbsp;print&nbsp;area</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Draw</span>&nbsp;<span class="key">String</span>&nbsp;<span class="oth">(</span><span class="num">24</span><span class="oth">,</span>&nbsp;<span class="num">432</span><span class="oth">),</span>&nbsp;<span class="key">Format</span><span class="oth">(</span><span class="key">Now</span><span class="oth">,</span><span class="quo">&quot;dd/mm/yyyy&quot;</span><span class="oth">),</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Draw</span>&nbsp;<span class="key">String</span>&nbsp;<span class="oth">(</span><span class="num">32</span><span class="oth">,</span>&nbsp;<span class="num">448</span><span class="oth">),</span>&nbsp;<span class="key">Format</span><span class="oth">(</span><span class="key">Now</span><span class="oth">,</span><span class="quo">&quot;hh:mm:ss&quot;</span><span class="oth">),</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenCopy</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="wrd">terminate</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">reply</span><br />
<span class="key">Locate</span>&nbsp;<span class="num">2</span><span class="oth">,</span>&nbsp;<span class="num">2</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;Enter&nbsp;&quot;&quot;q&quot;&quot;&nbsp;to&nbsp;quit&quot;</span><br />
<span class="key">ScreenCopy</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">thread</span><span class="oth">)</span><br />
<br />
<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">reply</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Inkey</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="key">LCase</span><span class="oth">(</span><span class="wrd">reply</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;q&quot;</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;Stop&nbsp;the&nbsp;thread&quot;</span><br />
<span class="key">ScreenCopy</span><br />
<span class="wrd">terminate</span><span class="oth">=</span><span class="num">1</span><br />
<span class="key">ThreadWait</span>&nbsp;<span class="oth">(</span><span class="wrd">p</span><span class="oth">)</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;Thread&nbsp;terminated&quot;</span><br />
<span class="key">ScreenCopy</span><br />
<br />
<span class="key">Sleep</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
Note: The <tt><i>Sleep x, 1</i></tt> keyword just after the 'clear the print area' line is only here to highlight the flickering if no double buffering is used.<br \>
<br \>
</div></div></div><ul><ul><li> From the above example, if the date displaying and the time displaying are now two separate threads, a mutual exclusion mutex code block between these two threads is mandatory, not due to the graphics statements themselves competing, but only due to the double buffering method used (against flickering) that puts competing these two threads:<br \>
</ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><tt><div class="freebasic">
<span class="def">#include&nbsp;&quot;vbcompat.bi&quot;<br />
</span><br />
<span class="key">Screen</span>&nbsp;<span class="num">12</span><span class="oth">,</span>&nbsp;<span class="oth">,</span>&nbsp;<span class="num">2</span><br />
<span class="key">ScreenSet</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">0</span>&nbsp;&nbsp;&nbsp;<br />
<span class="key">Color</span>&nbsp;<span class="num">0</span><span class="oth">,</span>&nbsp;<span class="num">7</span><br />
<span class="key">Cls</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="wrd">terminate</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="wrd">mutex</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">thread1</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">param</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenSet</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Line</span>&nbsp;<span class="oth">(</span><span class="num">16</span><span class="oth">,</span>&nbsp;<span class="num">432</span><span class="oth">)-</span><span class="key">Step</span><span class="oth">(</span><span class="num">96</span><span class="oth">,</span>&nbsp;<span class="num">16</span><span class="oth">),</span>&nbsp;<span class="num">11</span><span class="oth">,</span>&nbsp;<span class="wrd">BF</span>&nbsp;&nbsp;<span class="com">'clear&nbsp;the&nbsp;print&nbsp;area</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">200</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Draw</span>&nbsp;<span class="key">String</span>&nbsp;<span class="oth">(</span><span class="num">24</span><span class="oth">,</span>&nbsp;<span class="num">432</span><span class="oth">),</span>&nbsp;<span class="key">Format</span><span class="oth">(</span><span class="key">Now</span><span class="oth">,</span><span class="quo">&quot;dd/mm/yyyy&quot;</span><span class="oth">),</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenCopy</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="wrd">terminate</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">thread2</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">param</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenSet</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Line</span>&nbsp;<span class="oth">(</span><span class="num">16</span><span class="oth">,</span>&nbsp;<span class="num">448</span><span class="oth">)-</span><span class="key">Step</span><span class="oth">(</span><span class="num">96</span><span class="oth">,</span>&nbsp;<span class="num">16</span><span class="oth">),</span>&nbsp;<span class="num">11</span><span class="oth">,</span>&nbsp;<span class="wrd">BF</span>&nbsp;&nbsp;<span class="com">'clear&nbsp;the&nbsp;print&nbsp;area</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Draw</span>&nbsp;<span class="key">String</span>&nbsp;<span class="oth">(</span><span class="num">32</span><span class="oth">,</span>&nbsp;<span class="num">448</span><span class="oth">),</span>&nbsp;<span class="key">Format</span><span class="oth">(</span><span class="key">Now</span><span class="oth">,</span><span class="quo">&quot;hh:mm:ss&quot;</span><span class="oth">),</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenCopy</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="wrd">terminate</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">reply</span><br />
<span class="key">Locate</span>&nbsp;<span class="num">2</span><span class="oth">,</span>&nbsp;<span class="num">2</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;Enter&nbsp;&quot;&quot;q&quot;&quot;&nbsp;to&nbsp;quit&quot;</span><br />
<span class="key">ScreenCopy</span><br />
<br />
<span class="wrd">mutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><br />
<span class="key">Dim</span>&nbsp;<span class="wrd">p1</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">thread1</span><span class="oth">)</span><br />
<span class="key">Dim</span>&nbsp;<span class="wrd">p2</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">thread2</span><span class="oth">)</span><br />
<br />
<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">reply</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Inkey</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="key">LCase</span><span class="oth">(</span><span class="wrd">reply</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;q&quot;</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;Stop&nbsp;the&nbsp;threads&quot;</span><br />
<span class="key">ScreenCopy</span><br />
<span class="wrd">terminate</span><span class="oth">=</span><span class="num">1</span><br />
<span class="key">ThreadWait</span>&nbsp;<span class="oth">(</span><span class="wrd">p1</span><span class="oth">)</span><br />
<span class="key">ThreadWait</span>&nbsp;<span class="oth">(</span><span class="wrd">p2</span><span class="oth">)</span><br />
<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;Threads&nbsp;terminated&quot;</span><br />
<span class="key">ScreenCopy</span><br />
<br />
<span class="key">Sleep</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
Note: The <tt><i>Sleep x, 1</i></tt> keyword just after the 'clear the print area' lines is only here to highlight the flickering if no double buffering is used, or if no mutex is used.<br \>
<br \>
</div></div></div><div style="text-align: center;"><a href="#ProPgMtCriticalSectionsFAQtop">Back to top</a></div><br \>
<a name="ProPgMtCriticalSectionsFAQ9"></a><br \>
</div><div class="fb_sect_title">9. How to use console statements and keyboard inputs with multi-threading?</div><div class="fb_sect_cont"><br \>
<div class="fb_indent">Console statements (such as <tt><i>Locate</i></tt>, <tt><i>Print</i></tt>, <tt><i>Color</i></tt>, ...), as well as <tt><i>Locate</i></tt> and <tt><i>Print</i></tt> on Graphics window (but not <tt><i>Color</i></tt> on Graphics Window), and keyboard inputs (such as <tt><i>Inkey</i></tt>, <tt><i>Getkey</i></tt>, <tt><i>Input</i></tt>, ...) are not thread-safe:<br \>
<div class="fb_indent"><b>-</b> Thus when they are used in competing sections of different threads, mutual exclusion is mandatory by means of mutex locking blocks in which in addition code can restore states (such as text cursor position, console color, ...) at end of the block (after its own usage), as they were before (at begin of the block).<br \>
<b>-</b> But the <tt><i>Getkey</i></tt> or <tt><i>Input</i></tt> keyword cannot be enclosed inside a mutex locking block (as it can be do with the <tt><i>Inkey</i></tt> keyword), because as long as the keyboard input is not completed, the other threads in compete would be fully blocked (waiting for the mutex unlocking).<br \>
<br \>
</div></div><ul><ul><ul><li> Example showing that the keywords <tt><i>Locate</i></tt> and <tt><i>Print</i></tt> are not thread-safe both when applied on a console window or when applied on a graphics window (the text cursor states being not thread dependent in the two cases):<br \>
</ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><tt><div class="freebasic">
<span class="key">Sub</span>&nbsp;<span class="wrd">Thread</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">),</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">50</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">2</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">20</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">),</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="key">Str</span><span class="oth">(</span><span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">));</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">test</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">p</span><span class="oth">(</span><span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">9</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">9</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">p</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">Thread</span><span class="oth">,</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">,</span>&nbsp;<span class="wrd">I</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">25</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">9</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">p</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Screen</span>&nbsp;<span class="num">0</span><br />
<span class="wrd">test</span><span class="oth">()</span><br />
<span class="key">Locate</span>&nbsp;<span class="num">15</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;Any&nbsp;key&nbsp;to&nbsp;continue&quot;</span><br />
<span class="key">Sleep</span><br />
<br />
<span class="key">Screen</span>&nbsp;<span class="num">12</span><br />
<span class="wrd">test</span><span class="oth">()</span><br />
<span class="key">Locate</span>&nbsp;<span class="num">15</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;Any&nbsp;key&nbsp;to&nbsp;quit&quot;</span><br />
<span class="key">Sleep</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
Note: One can see that each thread does not write on its own line corresponding to its thread number (id between 1 and 9), on the console window and on the graphics window.<br \>
<br \>
</div></div></div></div><ul><ul><ul><li> From the above example, the thread code has been completed in its competing sections by mutex locking blocks and by saving/restoring cursor states before/after its own cursor moving:<br \>
</ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><tt><div class="freebasic">
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">mutex</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">Thread</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Long</span>&nbsp;<span class="wrd">l0</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Locate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">),</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Long</span>&nbsp;<span class="wrd">l</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Locate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="key">HiByte</span><span class="oth">(</span><span class="key">LoWord</span><span class="oth">(</span><span class="wrd">l0</span><span class="oth">)),</span>&nbsp;<span class="key">LoByte</span><span class="oth">(</span><span class="key">LoWord</span><span class="oth">(</span><span class="wrd">l0</span><span class="oth">)),</span>&nbsp;<span class="key">HiWord</span><span class="oth">(</span><span class="wrd">l0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">50</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">2</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">20</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">),</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">l0</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Locate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="key">HiByte</span><span class="oth">(</span><span class="key">LoWord</span><span class="oth">(</span><span class="wrd">l</span><span class="oth">)),</span>&nbsp;<span class="key">LoByte</span><span class="oth">(</span><span class="key">LoWord</span><span class="oth">(</span><span class="wrd">l</span><span class="oth">)),</span>&nbsp;<span class="key">HiWord</span><span class="oth">(</span><span class="wrd">l</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="key">Str</span><span class="oth">(</span><span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">));</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">l</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Locate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="key">HiByte</span><span class="oth">(</span><span class="key">LoWord</span><span class="oth">(</span><span class="wrd">l0</span><span class="oth">)),</span>&nbsp;<span class="key">LoByte</span><span class="oth">(</span><span class="key">LoWord</span><span class="oth">(</span><span class="wrd">l0</span><span class="oth">)),</span>&nbsp;<span class="key">HiWord</span><span class="oth">(</span><span class="wrd">l0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">test</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">p</span><span class="oth">(</span><span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">9</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">9</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">p</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">Thread</span><span class="oth">,</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">,</span>&nbsp;<span class="wrd">I</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">25</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">9</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">p</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="wrd">mutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><br />
<br />
<span class="key">Screen</span>&nbsp;<span class="num">0</span><br />
<span class="wrd">test</span><span class="oth">()</span><br />
<span class="key">Locate</span>&nbsp;<span class="num">15</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;Any&nbsp;key&nbsp;to&nbsp;continue&quot;</span><br />
<span class="key">Sleep</span><br />
<br />
<span class="key">Screen</span>&nbsp;<span class="num">12</span><br />
<span class="wrd">test</span><span class="oth">()</span><br />
<span class="key">Locate</span>&nbsp;<span class="num">15</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;Any&nbsp;key&nbsp;to&nbsp;quit&quot;</span><br />
<span class="key">Sleep</span><br />
<br />
<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
Note: One can see that each thread writes now on its own line corresponding to its thread number (id between 1 and 9), on the console window and on the graphics window.<br \>
<br \>
</div></div></div></div><ul><ul><ul><li> Example showing that the <tt><i>Color</i></tt> keyword is not thread-safe when applied on a console window, but is thread-safe when applied on a graphics window (the color states being thread dependent in that case):<br \>
</ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><tt><div class="freebasic">
<span class="key">Sub</span>&nbsp;<span class="wrd">Thread</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Color</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">8</span><span class="oth">,</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">50</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">2</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;&quot;</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="quo">&quot;&nbsp;&quot;</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">20</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">),</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">test</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">p</span><span class="oth">(</span><span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">9</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">9</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">p</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">Thread</span><span class="oth">,</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">,</span>&nbsp;<span class="wrd">I</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">25</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">9</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">p</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="num">16</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Screen</span>&nbsp;<span class="num">0</span><br />
<span class="wrd">test</span><span class="oth">()</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;Any&nbsp;key&nbsp;to&nbsp;continue&quot;</span><br />
<span class="key">Sleep</span><br />
<br />
<span class="key">Screen</span>&nbsp;<span class="num">12</span><br />
<span class="wrd">test</span><span class="oth">()</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;Any&nbsp;key&nbsp;to&nbsp;quit&quot;</span><br />
<span class="key">Sleep</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
Note: One can see that the foreground/background colors are not specific to the thread number (id between 1 and 9) on the console window, but this works great on the graphics window.<br \>
<br \>
</div></div></div></div><ul><ul><ul><li> From the above example, the thread code has been completed in its competing sections by mutex locking blocks and by saving/restoring color states before/after its own color values usage:<br \>
</ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><tt><div class="freebasic">
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">mutex</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">Thread</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">ULong</span>&nbsp;<span class="wrd">c0</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Color</span><span class="oth">(</span><span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">8</span><span class="oth">,</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">ULong</span>&nbsp;<span class="wrd">c</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Color</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Color</span><span class="oth">(</span><span class="key">LoWord</span><span class="oth">(</span><span class="wrd">c0</span><span class="oth">),</span>&nbsp;<span class="key">HiWord</span><span class="oth">(</span><span class="wrd">c0</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">50</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">2</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">c0</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Color</span><span class="oth">(</span><span class="key">LoWord</span><span class="oth">(</span><span class="wrd">c</span><span class="oth">),</span>&nbsp;<span class="key">HiWord</span><span class="oth">(</span><span class="wrd">c</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;&quot;</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="quo">&quot;&nbsp;&quot;</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Color</span><span class="oth">(</span><span class="key">LoWord</span><span class="oth">(</span><span class="wrd">c0</span><span class="oth">),</span>&nbsp;<span class="key">HiWord</span><span class="oth">(</span><span class="wrd">c0</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">20</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Integer</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">),</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">test</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">p</span><span class="oth">(</span><span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">9</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">9</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">p</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">Thread</span><span class="oth">,</span>&nbsp;<span class="key">Cast</span><span class="oth">(</span><span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">,</span>&nbsp;<span class="wrd">I</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">25</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">9</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">p</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="num">16</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="wrd">mutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><br />
<br />
<span class="key">Screen</span>&nbsp;<span class="num">0</span><br />
<span class="wrd">test</span><span class="oth">()</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;Any&nbsp;key&nbsp;to&nbsp;continue&quot;</span><br />
<span class="key">Sleep</span><br />
<br />
<span class="key">Screen</span>&nbsp;<span class="num">12</span><br />
<span class="wrd">test</span><span class="oth">()</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;Any&nbsp;key&nbsp;to&nbsp;quit&quot;</span><br />
<span class="key">Sleep</span><br />
<br />
<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
Note: One can see that the foreground/background colors are now specific to the thread number (id between 1 and 9) on the console window (obviously this always works on the graphics window).<br \>
<br \>
</div></div></div>Therefore, for using Getkey or Input in competing sections of threads:<br \>
<div class="fb_indent"><b>-</b> Only a single thread (for example, the main thread) can uses <tt><i>Getkey</i></tt> or <tt><i>Input</i></tt> in addition to console statements (such as <tt><i>Locate</i></tt>, <tt><i>Print</i></tt>, <tt><i>Color</i></tt>, ...) and also <tt><i>Inkey</i></tt>, in its competing sections.<br \>
<b>-</b> The other threads must not to use in their competing sections any console statement neither any keyboard input keyword, but can use by cons graphics statements (such as <tt><i>Pset</i></tt>, <tt><i>Line</i></tt>, <tt><i>Circle</i></tt>, <tt><i>Draw String</i></tt>, graphic <tt><i>Color</i></tt>, ...) which are themselves thread-safe (they can interlace graphically with the main thread without any problem).<br \>
<b>-</b> <tt><i>Input</i></tt> and <tt><i>Getkey</i></tt> also exclude the screen locking usage in competing sections of threads (double buffering is recommended as anti-flickering method).<br \>
<br \>
</div></div><ul><ul><ul><li> Example showing that graphics statements (such as <tt><i>Line</i></tt> and <tt><i>Draw String</i></tt> and <tt><i>Screencopy</i></tt>) in a thread (user thread here) can compete with console statements (such as <tt><i>Locate</i></tt> and <tt><i>Print</i></tt> and <tt><i>Input</i></tt>) in another thread (main thread here), without using any mutual exclusion (by mutex):<br \>
</ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><tt><div class="freebasic">
<span class="def">#include&nbsp;&quot;vbcompat.bi&quot;<br />
</span><br />
<span class="key">Screen</span>&nbsp;<span class="num">12</span><span class="oth">,</span>&nbsp;<span class="oth">,</span>&nbsp;<span class="num">2</span><br />
<span class="key">ScreenSet</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">0</span>&nbsp;&nbsp;&nbsp;<br />
<span class="key">Color</span>&nbsp;<span class="num">0</span><span class="oth">,</span>&nbsp;<span class="num">7</span><br />
<span class="key">Cls</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="wrd">terminate</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">thread</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">param</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenSet</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Line</span>&nbsp;<span class="oth">(</span><span class="num">16</span><span class="oth">,</span>&nbsp;<span class="num">432</span><span class="oth">)-</span><span class="key">Step</span><span class="oth">(</span><span class="num">96</span><span class="oth">,</span>&nbsp;<span class="num">32</span><span class="oth">),</span>&nbsp;<span class="num">11</span><span class="oth">,</span>&nbsp;<span class="wrd">BF</span>&nbsp;&nbsp;<span class="com">'clear&nbsp;the&nbsp;print&nbsp;area</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Draw</span>&nbsp;<span class="key">String</span>&nbsp;<span class="oth">(</span><span class="num">24</span><span class="oth">,</span>&nbsp;<span class="num">432</span><span class="oth">),</span>&nbsp;<span class="key">Format</span><span class="oth">(</span><span class="key">Now</span><span class="oth">,</span><span class="quo">&quot;dd/mm/yyyy&quot;</span><span class="oth">),</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Draw</span>&nbsp;<span class="key">String</span>&nbsp;<span class="oth">(</span><span class="num">32</span><span class="oth">,</span>&nbsp;<span class="num">448</span><span class="oth">),</span>&nbsp;<span class="key">Format</span><span class="oth">(</span><span class="key">Now</span><span class="oth">,</span><span class="quo">&quot;hh:mm:ss&quot;</span><span class="oth">),</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenCopy</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="wrd">terminate</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">reply</span><br />
<span class="key">Locate</span>&nbsp;<span class="num">2</span><span class="oth">,</span>&nbsp;<span class="num">2</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;Enter&nbsp;&quot;&quot;quit&quot;&quot;&nbsp;to&nbsp;quit&quot;</span><br />
<span class="key">ScreenCopy</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">thread</span><span class="oth">)</span><br />
<br />
<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="num">3</span><span class="oth">,</span>&nbsp;<span class="num">2</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="key">Space</span><span class="oth">(</span><span class="key">Len</span><span class="oth">(</span><span class="wrd">reply</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">2</span><span class="oth">);</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="num">3</span><span class="oth">,</span>&nbsp;<span class="num">2</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Input</span>&nbsp;<span class="wrd">reply</span><br />
<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="key">LCase</span><span class="oth">(</span><span class="wrd">reply</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;quit&quot;</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;Stop&nbsp;the&nbsp;thread&quot;</span><br />
<span class="key">ScreenCopy</span><br />
<span class="wrd">terminate</span><span class="oth">=</span><span class="num">1</span><br />
<span class="key">ThreadWait</span>&nbsp;<span class="oth">(</span><span class="wrd">p</span><span class="oth">)</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;Thread&nbsp;terminated&quot;</span><br />
<span class="key">ScreenCopy</span><br />
<br />
<span class="key">Sleep</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
Note: The <tt><i>Sleep x, 1</i></tt> keyword just after the 'clear the print area' line is only here to highlight the flickering if no double buffering is used (screen locking being forbidden by Input usage).<br \>
<br \>
</div></div></div></div><ul><ul><ul><li> From the above example, if the date displaying and the time displaying are now two separate user threads, a mutual exclusion mutex code block between these two threads only is mandatory, not due to the graphics statements themselves competing, but only due to the double buffering method used (against flickering) that puts competing these two user threads only:<br \>
</ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><tt><div class="freebasic">
<span class="def">#include&nbsp;&quot;vbcompat.bi&quot;<br />
</span><br />
<span class="key">Screen</span>&nbsp;<span class="num">12</span><span class="oth">,</span>&nbsp;<span class="oth">,</span>&nbsp;<span class="num">2</span><br />
<span class="key">ScreenSet</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">0</span>&nbsp;&nbsp;&nbsp;<br />
<span class="key">Color</span>&nbsp;<span class="num">0</span><span class="oth">,</span>&nbsp;<span class="num">7</span><br />
<span class="key">Cls</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="wrd">terminate</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="wrd">mutex</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">thread1</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">param</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenSet</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Line</span>&nbsp;<span class="oth">(</span><span class="num">16</span><span class="oth">,</span>&nbsp;<span class="num">432</span><span class="oth">)-</span><span class="key">Step</span><span class="oth">(</span><span class="num">96</span><span class="oth">,</span>&nbsp;<span class="num">16</span><span class="oth">),</span>&nbsp;<span class="num">11</span><span class="oth">,</span>&nbsp;<span class="wrd">BF</span>&nbsp;&nbsp;<span class="com">'clear&nbsp;the&nbsp;print&nbsp;area</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">200</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Draw</span>&nbsp;<span class="key">String</span>&nbsp;<span class="oth">(</span><span class="num">24</span><span class="oth">,</span>&nbsp;<span class="num">432</span><span class="oth">),</span>&nbsp;<span class="key">Format</span><span class="oth">(</span><span class="key">Now</span><span class="oth">,</span><span class="quo">&quot;dd/mm/yyyy&quot;</span><span class="oth">),</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenCopy</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="wrd">terminate</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">thread2</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">param</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenSet</span>&nbsp;<span class="num">1</span><span class="oth">,</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Line</span>&nbsp;<span class="oth">(</span><span class="num">16</span><span class="oth">,</span>&nbsp;<span class="num">448</span><span class="oth">)-</span><span class="key">Step</span><span class="oth">(</span><span class="num">96</span><span class="oth">,</span>&nbsp;<span class="num">16</span><span class="oth">),</span>&nbsp;<span class="num">11</span><span class="oth">,</span>&nbsp;<span class="wrd">BF</span>&nbsp;&nbsp;<span class="com">'clear&nbsp;the&nbsp;print&nbsp;area</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Draw</span>&nbsp;<span class="key">String</span>&nbsp;<span class="oth">(</span><span class="num">32</span><span class="oth">,</span>&nbsp;<span class="num">448</span><span class="oth">),</span>&nbsp;<span class="key">Format</span><span class="oth">(</span><span class="key">Now</span><span class="oth">,</span><span class="quo">&quot;hh:mm:ss&quot;</span><span class="oth">),</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ScreenCopy</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="wrd">terminate</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">reply</span><br />
<span class="key">Locate</span>&nbsp;<span class="num">2</span><span class="oth">,</span>&nbsp;<span class="num">2</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;Enter&nbsp;&quot;&quot;quit&quot;&quot;&nbsp;to&nbsp;quit&quot;</span><br />
<span class="key">ScreenCopy</span><br />
<br />
<span class="wrd">mutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><br />
<span class="key">Dim</span>&nbsp;<span class="wrd">p1</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">thread1</span><span class="oth">)</span><br />
<span class="key">Dim</span>&nbsp;<span class="wrd">p2</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">thread2</span><span class="oth">)</span><br />
<br />
<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="num">3</span><span class="oth">,</span>&nbsp;<span class="num">2</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="key">Space</span><span class="oth">(</span><span class="key">Len</span><span class="oth">(</span><span class="wrd">reply</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">2</span><span class="oth">);</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="num">3</span><span class="oth">,</span>&nbsp;<span class="num">2</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Input</span>&nbsp;<span class="wrd">reply</span><br />
<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="key">LCase</span><span class="oth">(</span><span class="wrd">reply</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;quit&quot;</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;Stop&nbsp;the&nbsp;threads&quot;</span><br />
<span class="key">ScreenCopy</span><br />
<span class="wrd">terminate</span><span class="oth">=</span><span class="num">1</span><br />
<span class="key">ThreadWait</span>&nbsp;<span class="oth">(</span><span class="wrd">p1</span><span class="oth">)</span><br />
<span class="key">ThreadWait</span>&nbsp;<span class="oth">(</span><span class="wrd">p2</span><span class="oth">)</span><br />
<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">mutex</span><span class="oth">)</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;Threads&nbsp;terminated&quot;</span><br />
<span class="key">ScreenCopy</span><br />
<br />
<span class="key">Sleep</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
Note: The <tt><i>Sleep x, 1</i></tt> keyword just after the 'clear the print area' lines is only here to highlight the flickering if no double buffering is used (screen locking being forbidden by Input usage).<br \>
<br \>
</div></div></div></div><div style="text-align: center;"><a href="#ProPgMtCriticalSectionsFAQtop">Back to top</a></div><br \>
<a name="ProPgMtCriticalSectionsFAQ10"></a><br \>
</div><div class="fb_sect_title">10. Is it better to take precautions when using the keyword 'Sleep' in threads?</div><div class="fb_sect_cont"><br \>
<div class="fb_indent">There is still some doubt about the perfect behavior of the keyword <tt><i>Sleep</i></tt> in a multi-threading context.<br \>
<br \>
It is therefore advisable to take the following precautions for its use:<br \>
<div class="fb_indent"><b>-</b> If it is absolutely necessary in a critical section of a thread, the syntax <tt><i>Sleep x</i></tt> or <tt><i>Sleep x, 0</i></tt>, because inducing an internal test of a key-press, must for greatest safety be preferably treated in the same way as the <tt><i>Inkey</i></tt> keyword to avoid as much as possible any concurrent conflict with other threads.<br \>
<b>-</b> Otherwise, the syntax <tt><i>Sleep x, 1</i></tt> (inducing no internal test of key-press) is rather advised when there is no protection by mutual exclusion, which is very often the case in order to release time-slice for the other threads.<br \>
<br \>
</div></div><div style="text-align: center;"><a href="#ProPgMtCriticalSectionsFAQtop">Back to top</a></div><br \>
<a name="ProPgMtCriticalSectionsFAQ11"></a><br \>
</div><div class="fb_sect_title">11. Can all tools to handle multi-threading be encapsulated in a base Class (that the user extends with a derived Type for his own implementing)?</div><div class="fb_sect_cont"><br \>
<div class="fb_indent">A simple 'threadUDT' base Class can be defined as follows:<br \>
<div class="fb_indent"><b>-</b> with a private 'Any Ptr' non-static member field for each handle,<br \>
<b>-</b> with a private 'Any Ptr' static member field for one shared mutex,<br \>
<b>-</b> with a private 'Any Ptr' static member field for one shared conditional variable,<br \>
<b>-</b> with its own public member procedures 'Sub()' calling the corresponding built-in procedures for multi-threading (with same procedure names), including also value integrity tests on the 3 above pointers (non-static procedures for the 3 'thread...()' member Subs, and static procedures for the 4 'mutex...()' member Subs and the 5 'cond...()' member Subs),<br \>
<b>-</b> with an abstract private 'Sub()' thread to be overridden by another 'Sub()' from inside the user derived Type (therefore its static address is available in the virtual table of the object, and the hidden 'This' parameter passed by reference is compatible with the 'Any Ptr' parameter to be passed to the thread).<br \>
<div class="fb_indent"><tt><div class="freebasic">
<span class="def">#include&nbsp;Once&nbsp;&quot;fbthread.bi&quot;<br />
</span><span class="key">Type</span>&nbsp;<span class="wrd">threadUDT</span>&nbsp;<span class="key">Extends</span>&nbsp;<span class="key">Object</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Public</span><span class="oth">:</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">ThreadCreate</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">ThreadWait</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">ThreadDetach</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">MutexCreate</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">MutexLock</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">MutexUnlock</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">MutexDestroy</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">CondCreate</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">CondWait</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">CondSignal</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">CondBroadcast</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">CondDestroy</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Private</span><span class="oth">:</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Abstract</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">thread</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">pThread</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">pMutex</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">pCond</span><br />
<span class="key">End</span>&nbsp;<span class="key">Type</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">threadUDT.pMutex</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">threadUDT.pCond</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.threadCreate</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">This.pThread</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This.pThread</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="oth">.</span><span class="key">ThreadCreate</span><span class="oth">(</span><span class="key">Cast</span><span class="oth">(</span><span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="key">Ptr</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="key">This</span><span class="oth">)[</span><span class="num">0</span><span class="oth">][</span><span class="num">0</span><span class="oth">],</span>&nbsp;<span class="oth">@</span><span class="key">This</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.threadWait</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">This.pThread</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">This.pThread</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This.pThread</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.threadDetach</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">This.pThread</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">ThreadDetach</span><span class="oth">(</span><span class="wrd">This.pThread</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This.pThread</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
&nbsp;&nbsp;<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.mutexCreate</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">threadUDT.pMutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">threadUDT.pMutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="oth">.</span><span class="key">MutexCreate</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
&nbsp;&nbsp;<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.mutexLock</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">threadUDT.pMutex</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">threadUDT.pMutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.mutexUnlock</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">threadUDT.pMutex</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">threadUDT.pMutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.mutexDestroy</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">threadUDT.pMutex</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">threadUDT.pMutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">threadUDT.pMutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.condCreate</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">threadUDT.pCond</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">threadUDT.pCond</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="oth">.</span><span class="key">CondCreate</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.condWait</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">threadUDT.pCond</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">And</span>&nbsp;<span class="wrd">threadUDT.pMutex</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">CondWait</span><span class="oth">(</span><span class="wrd">threadUDT.pCond</span><span class="oth">,</span>&nbsp;<span class="wrd">threadUDT.pMutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.condSignal</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">threadUDT.pCond</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">And</span>&nbsp;<span class="wrd">threadUDT.pMutex</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">CondSignal</span><span class="oth">(</span><span class="wrd">threadUDT.pCond</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.condBroadcast</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">threadUDT.pCond</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">And</span>&nbsp;<span class="wrd">threadUDT.pMutex</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">CondBroadcast</span><span class="oth">(</span><span class="wrd">threadUDT.pCond</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.condDestroy</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">threadUDT.pCond</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">CondDestroy</span><span class="oth">(</span><span class="wrd">threadUDT.pCond</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">threadUDT.pCond</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
</div></div></div><ul><ul><li> From the example 2 on the <tt><a href="ProPgMtCriticalSections.html">Critical Sections</a></tt> page "Synchronous method example using a condwait then a condbroadcast (and a mutex) for all threads", now the user implementation is modified to be compatible with the base Class 'threadUDT':<br \>
</ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><tt><div class="freebasic">
<span class="def">#include&nbsp;Once&nbsp;&quot;fbthread.bi&quot;<br />
</span><span class="key">Type</span>&nbsp;<span class="wrd">threadUDT</span>&nbsp;<span class="key">Extends</span>&nbsp;<span class="key">Object</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Public</span><span class="oth">:</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">ThreadCreate</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">ThreadWait</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">ThreadDetach</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">MutexCreate</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">MutexLock</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">MutexUnlock</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">MutexDestroy</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">CondCreate</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">CondWait</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">CondSignal</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">CondBroadcast</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="key">CondDestroy</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Private</span><span class="oth">:</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Abstract</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">thread</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">pThread</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">pMutex</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">pCond</span><br />
<span class="key">End</span>&nbsp;<span class="key">Type</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">threadUDT.pMutex</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">threadUDT.pCond</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.threadCreate</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">This.pThread</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This.pThread</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="oth">.</span><span class="key">ThreadCreate</span><span class="oth">(</span><span class="key">Cast</span><span class="oth">(</span><span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="key">Ptr</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="key">This</span><span class="oth">)[</span><span class="num">0</span><span class="oth">][</span><span class="num">0</span><span class="oth">],</span>&nbsp;<span class="oth">@</span><span class="key">This</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.threadWait</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">This.pThread</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">This.pThread</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This.pThread</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.threadDetach</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">This.pThread</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">ThreadDetach</span><span class="oth">(</span><span class="wrd">This.pThread</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This.pThread</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
&nbsp;&nbsp;<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.mutexCreate</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">threadUDT.pMutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">threadUDT.pMutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="oth">.</span><span class="key">MutexCreate</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
&nbsp;&nbsp;<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.mutexLock</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">threadUDT.pMutex</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">threadUDT.pMutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.mutexUnlock</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">threadUDT.pMutex</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">threadUDT.pMutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.mutexDestroy</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">threadUDT.pMutex</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">threadUDT.pMutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">threadUDT.pMutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.condCreate</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">threadUDT.pCond</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">threadUDT.pCond</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="oth">.</span><span class="key">CondCreate</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.condWait</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">threadUDT.pCond</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">And</span>&nbsp;<span class="wrd">threadUDT.pMutex</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">CondWait</span><span class="oth">(</span><span class="wrd">threadUDT.pCond</span><span class="oth">,</span>&nbsp;<span class="wrd">threadUDT.pMutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.condSignal</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">threadUDT.pCond</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">And</span>&nbsp;<span class="wrd">threadUDT.pMutex</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">CondSignal</span><span class="oth">(</span><span class="wrd">threadUDT.pCond</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.condBroadcast</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">threadUDT.pCond</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">And</span>&nbsp;<span class="wrd">threadUDT.pMutex</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">CondBroadcast</span><span class="oth">(</span><span class="wrd">threadUDT.pCond</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">threadUDT.condDestroy</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">threadUDT.pCond</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">CondDestroy</span><span class="oth">(</span><span class="wrd">threadUDT.pCond</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">threadUDT.pCond</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="com">'------------------------------------------------------------------------------</span><br />
<br />
<span class="key">Type</span>&nbsp;<span class="wrd">UDT</span>&nbsp;<span class="key">Extends</span>&nbsp;<span class="wrd">threadUDT</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">counter</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">thread</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">number</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">tempo</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">ULongInt</span>&nbsp;<span class="wrd">count</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">threadPriorityNumber</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">numberMax</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">quit</span><br />
<span class="key">End</span>&nbsp;<span class="key">Type</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">UDT.threadPriorityNumber</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">UDT.numberMax</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">UDT.quit</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">UDT.counter</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="wrd">This.number</span><span class="oth">,</span>&nbsp;<span class="wrd">This.number</span><span class="oth">,</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">5</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This.count</span>&nbsp;<span class="oth">+=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="wrd">This.count</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Locate</span>&nbsp;<span class="wrd">This.number</span><span class="oth">,</span>&nbsp;<span class="num">30</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="wrd">This.number</span><span class="oth">,</span>&nbsp;<span class="num">0</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">UDT.Thread</span>&nbsp;<span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">myquit</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This.mutexLock</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">While</span>&nbsp;<span class="wrd">UDT.threadPriorityNumber</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="wrd">This.number</span>&nbsp;&nbsp;<span class="com">''&nbsp;synchronous&nbsp;condwait&nbsp;for&nbsp;expected&nbsp;condition</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This.condWait</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Wend</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This.counter</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">myquit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">UDT.quit</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">UDT.threadPriorityNumber</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="oth">(</span><span class="wrd">UDT.threadPriorityNumber</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span>&nbsp;<span class="key">Mod</span>&nbsp;<span class="oth">(</span><span class="wrd">UDT.numberMax</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This.condBroadcast</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This.mutexUnlock</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="wrd">This.tempo</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="wrd">myquit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<br />
<span class="wrd">UDT.numberMax</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">6</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">UDT</span>&nbsp;<span class="wrd">u</span><span class="oth">(</span><span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">UDT.numberMax</span><span class="oth">)</span><br />
<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">UDT.numberMax</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">u</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">).</span><span class="wrd">number</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">i</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">u</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">).</span><span class="wrd">tempo</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">100</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">15</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">95</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">Sgn</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span><br />
<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="wrd">UDT.mutexCreate</span><span class="oth">()</span><br />
<span class="wrd">UDT.condCreate</span><span class="oth">()</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Single</span>&nbsp;<span class="wrd">t</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Timer</span><br />
<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">UDT.numberMax</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">u</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">).</span><span class="key">ThreadCreate</span><span class="oth">()</span><br />
<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">s</span><br />
<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">UDT.mutexLock</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">While</span>&nbsp;<span class="wrd">UDT.threadPriorityNumber</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="wrd">u</span><span class="oth">(</span><span class="num">0</span><span class="oth">).</span><span class="wrd">number</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">UDT.condWait</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Wend</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">s</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Inkey</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">s</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="quo">&quot;&quot;</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">UDT.quit</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">UDT.threadPriorityNumber</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="oth">(</span><span class="wrd">UDT.threadPriorityNumber</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span>&nbsp;<span class="key">Mod</span>&nbsp;<span class="oth">(</span><span class="wrd">UDT.numberMax</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">UDT.condBroadcast</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">UDT.mutexUnlock</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="wrd">u</span><span class="oth">(</span><span class="num">0</span><span class="oth">).</span><span class="wrd">tempo</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="wrd">s</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="quo">&quot;&quot;</span><br />
<br />
<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">UDT.numberMax</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">u</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">).</span><span class="key">ThreadWait</span><span class="oth">()</span><br />
<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="wrd">t</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Timer</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="wrd">t</span><br />
<br />
<span class="wrd">UDT.mutexDestroy</span><span class="oth">()</span><br />
<span class="wrd">UDT.condDestroy</span><span class="oth">()</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">ULongInt</span>&nbsp;<span class="wrd">c</span><br />
<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">UDT.numberMax</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">c</span>&nbsp;<span class="oth">+=</span>&nbsp;<span class="wrd">u</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">).</span><span class="wrd">count</span><br />
<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="key">Locate</span>&nbsp;<span class="wrd">UDT.numberMax</span><span class="oth">+</span><span class="num">2</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
<span class="key">Print</span>&nbsp;<span class="key">CULngInt</span><span class="oth">(</span><span class="wrd">c</span>&nbsp;<span class="oth">/</span>&nbsp;<span class="wrd">t</span><span class="oth">)</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="quo">&quot;&nbsp;increments&nbsp;per&nbsp;second&quot;</span><br />
<br />
<span class="key">Sleep</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
</div></div></div><div style="text-align: center;"><a href="#ProPgMtCriticalSectionsFAQtop">Back to top</a></div><br \>
<a name="ProPgMtCriticalSectionsFAQ12"></a><br \>
</div><div class="fb_sect_title">12. Can we emulate a kind of TLS (Thread Local Storage) with FreeBASIC?</div><div class="fb_sect_cont"><br \>
<div class="fb_indent">Static variables are normally shared across all the threads. If we modify a static variable, it is visible so modified to all the threads.<br \>
Unlike normal static variable, if we create a TLS static variable, every thread must have its own copy of the variable (but with the same access name), i.e. any change to the variable is local to the thread (locally stored).<br \>
This allows to create a thread-safe procedure, because each call to this procedure gets its own copy of the same declared static variables.<br \>
In normal procedure with static variables, the content of that variables can be updated by multiple threads, but with TLS, we can think of these as static data but local to each thread.<br \>
<br \>
TLS data is similar to static data, but the only difference is that TLS data are unique to each thread.<br \>
<br \>
The principle of this TLS emulation for FreeBASIC is to use a static array for each requested TLS variable, where each thread has its own unique index (hidden) to access the array element.<br \>
This unique index relating to the thread is deduced from the thread handle value:<br \>
<div class="fb_indent"><b>-</b> With fbc version &gt;= 1.08, the thread handle value is simply returned from the 'Threadself()' function calling (new function) from any thread.<br \>
<b>-</b> With fbc version &lt; 1.08, the code is more twisted:<br \>
<div class="fb_indent"><div class="fb_indent">- The thread handle value is only accessible from the 'ThreadCreate()' return in the parent (or main) thread when creating it.<br \>
- There is no way to properly emulate the 'Threadself()' function, but only by a twisted method.<br \>
- In the example below (for fbc version &lt; 1.08), a 'Threadself()' function (returning by reference) value is initialized before each use by the thread (with its own thread handle), and all of this (initialization + use) protected by a mutex as for its corresponding 'ThreadCreate()'.<br \>
<br \>
</div></div></div>In the below example, the TLS static variable is an integer which is used in a single and generic counting procedure ('counter()') with none passed parameter). This counting procedure is called by each thread (thus each thread counts independently of each other but by calling the same single counting procedure).<br \>
A single macro allows to define any TLS variable (except array) of any type.<br \>
<br \>
</div><ul><ul><li> Code with preprocessor conditional directives depending on fbc version:<br \>
</ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><tt><div class="freebasic">
<span class="def">#include&nbsp;Once&nbsp;&quot;crt/string.bi&quot;<br />
</span><br />
<span class="def">#if&nbsp;__FB_VERSION__&nbsp;&lt;&nbsp;&quot;1.08&quot;<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'&nbsp;Emulation&nbsp;of&nbsp;the&nbsp;function&nbsp;Threadself()&nbsp;of&nbsp;FreeBASIC</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'&nbsp;Before&nbsp;each&nbsp;use,&nbsp;the&nbsp;thread&nbsp;must&nbsp;refresh&nbsp;this&nbsp;function&nbsp;value&nbsp;with&nbsp;its&nbsp;own&nbsp;thread&nbsp;handle,</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'&nbsp;and&nbsp;all&nbsp;of&nbsp;this&nbsp;(refreshing&nbsp;+&nbsp;use)&nbsp;protected&nbsp;by&nbsp;a&nbsp;mutex.</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Function</span>&nbsp;<span class="key">ThreadSelf</span>&nbsp;<span class="oth">()</span>&nbsp;<span class="key">ByRef</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">handle</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="wrd">handle</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<span class="def">#else<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#include&nbsp;Once&nbsp;&quot;fbthread.bi&quot;<br />
#endif<br />
</span><br />
<span class="def">#macro&nbsp;CreateTLSdatatypeVariableFunction&nbsp;(variable_function_name,&nbsp;variable_datatype)<br />
</span><span class="com">'&nbsp;Creation&nbsp;of&nbsp;a&nbsp;&quot;variable_function_name&quot;&nbsp;function&nbsp;to&nbsp;emulate&nbsp;a&nbsp;static&nbsp;datatype&nbsp;variable&nbsp;(not&nbsp;an&nbsp;array),</span><br />
<span class="com">'&nbsp;with&nbsp;a&nbsp;value&nbsp;depending&nbsp;on&nbsp;the&nbsp;thread&nbsp;using&nbsp;it.</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Function</span>&nbsp;<span class="wrd">variable_function_name</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">cd</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Boolean</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">True</span><span class="oth">)</span>&nbsp;<span class="key">ByRef</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">variable_datatype</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'&nbsp;Function&nbsp;emulating&nbsp;(creation/access/destruction)&nbsp;a&nbsp;static&nbsp;datatype&nbsp;variable&nbsp;with&nbsp;value&nbsp;depending&nbsp;on&nbsp;thread&nbsp;using&nbsp;it:</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'&nbsp;If&nbsp;calling&nbsp;without&nbsp;parameter&nbsp;(or&nbsp;with&nbsp;'True')&nbsp;parameter,&nbsp;this&nbsp;allows&nbsp;to&nbsp;[create&nbsp;and]&nbsp;access&nbsp;the&nbsp;static&nbsp;datatype&nbsp;variable.</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'&nbsp;If&nbsp;calling&nbsp;with&nbsp;the&nbsp;'False'&nbsp;parameter,&nbsp;this&nbsp;allows&nbsp;to&nbsp;destroy&nbsp;the&nbsp;static&nbsp;datatype&nbsp;variable.</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">bound</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">TLSindex</span><span class="oth">(</span><span class="wrd">bound</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">variable_datatype</span>&nbsp;<span class="wrd">TLSdata</span><span class="oth">(</span><span class="wrd">bound</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">Threadhandle</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadSelf</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">index</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">TLSindex</span><span class="oth">)</span>&nbsp;&nbsp;<span class="com">'&nbsp;search&nbsp;existing&nbsp;TLS&nbsp;variable&nbsp;(existing&nbsp;array&nbsp;element)&nbsp;for&nbsp;the&nbsp;running&nbsp;thread</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">TLSindex</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">Threadhandle</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">index</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Exit</span>&nbsp;<span class="key">For</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">index</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">And</span>&nbsp;<span class="wrd">cd</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">True</span>&nbsp;<span class="key">Then</span>&nbsp;&nbsp;<span class="com">'&nbsp;create&nbsp;a&nbsp;new&nbsp;TLS&nbsp;variable&nbsp;(new&nbsp;array&nbsp;element)&nbsp;for&nbsp;a&nbsp;new&nbsp;thread</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">index</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">TLSindex</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">TLSindex</span><span class="oth">(</span><span class="wrd">index</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">TLSindex</span><span class="oth">(</span><span class="wrd">index</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">Threadhandle</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">TLSdata</span><span class="oth">(</span><span class="wrd">index</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ElseIf</span>&nbsp;<span class="wrd">index</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">And</span>&nbsp;<span class="wrd">cd</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">False</span>&nbsp;<span class="key">Then</span>&nbsp;&nbsp;<span class="com">'&nbsp;destroy&nbsp;a&nbsp;TLS&nbsp;variable&nbsp;(array&nbsp;element)&nbsp;and&nbsp;compact&nbsp;the&nbsp;array</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">index</span>&nbsp;<span class="oth">&lt;</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">TLSindex</span><span class="oth">)</span>&nbsp;<span class="key">Then</span>&nbsp;&nbsp;<span class="com">'&nbsp;reorder&nbsp;the&nbsp;array&nbsp;elements</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">memmove</span><span class="oth">(@</span><span class="wrd">TLSindex</span><span class="oth">(</span><span class="wrd">index</span><span class="oth">),</span>&nbsp;<span class="oth">@</span><span class="wrd">TLSindex</span><span class="oth">(</span><span class="wrd">index</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">),</span>&nbsp;<span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">TLSindex</span><span class="oth">)</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="wrd">index</span><span class="oth">)</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">SizeOf</span><span class="oth">(</span><span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">variable_datatype</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Allocate</span><span class="oth">(</span><span class="key">SizeOf</span><span class="oth">(</span><span class="wrd">variable_datatype</span><span class="oth">))</span>&nbsp;&nbsp;<span class="com">'&nbsp;for&nbsp;compatibility&nbsp;to&nbsp;object&nbsp;with&nbsp;destructor</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">memmove</span><span class="oth">(</span><span class="wrd">p</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">TLSdata</span><span class="oth">(</span><span class="wrd">index</span><span class="oth">),</span>&nbsp;<span class="key">SizeOf</span><span class="oth">(</span><span class="wrd">variable_datatype</span><span class="oth">))</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'&nbsp;for&nbsp;compatibility&nbsp;to&nbsp;object&nbsp;with&nbsp;destructor</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">memmove</span><span class="oth">(@</span><span class="wrd">TLSdata</span><span class="oth">(</span><span class="wrd">index</span><span class="oth">),</span>&nbsp;<span class="oth">@</span><span class="wrd">TLSdata</span><span class="oth">(</span><span class="wrd">index</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">),</span>&nbsp;<span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">TLSdata</span><span class="oth">)</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="wrd">index</span><span class="oth">)</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">SizeOf</span><span class="oth">(</span><span class="wrd">variable_datatype</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">memmove</span><span class="oth">(@</span><span class="wrd">TLSdata</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">TLSdata</span><span class="oth">)),</span>&nbsp;<span class="wrd">p</span><span class="oth">,</span>&nbsp;<span class="key">SizeOf</span><span class="oth">(</span><span class="wrd">variable_datatype</span><span class="oth">))</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'&nbsp;for&nbsp;compatibility&nbsp;to&nbsp;object&nbsp;with&nbsp;destructor</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Deallocate</span><span class="oth">(</span><span class="wrd">p</span><span class="oth">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'&nbsp;for&nbsp;compatibility&nbsp;to&nbsp;object&nbsp;with&nbsp;destructor</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">TLSindex</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">TLSindex</span><span class="oth">)</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">TLSdata</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">TLSdata</span><span class="oth">)</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">index</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="wrd">TLSdata</span><span class="oth">(</span><span class="wrd">index</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<span class="def">#endmacro<br />
</span><br />
<span class="com">'------------------------------------------------------------------------------</span><br />
<br />
<span class="key">Type</span>&nbsp;<span class="wrd">threadData</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">handle</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">prefix</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">suffix</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Double</span>&nbsp;<span class="wrd">tempo</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#if&nbsp;__FB_VERSION__&nbsp;&lt;&nbsp;&quot;1.08&quot;<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Static</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">mutex</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#endif<br />
</span><span class="key">End</span>&nbsp;<span class="key">Type</span><br />
<span class="def">#if&nbsp;__FB_VERSION__&nbsp;&lt;&nbsp;&quot;1.08&quot;<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">threadData.mutex</span><br />
<span class="def">#endif<br />
</span><br />
<span class="wrd">CreateTLSdatatypeVariableFunction</span>&nbsp;<span class="oth">(</span><span class="wrd">TLScount</span><span class="oth">,</span>&nbsp;<span class="key">Integer</span><span class="oth">)</span>&nbsp;&nbsp;<span class="com">'&nbsp;create&nbsp;a&nbsp;TLS&nbsp;static&nbsp;integer&nbsp;function</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">counter</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;&nbsp;<span class="com">'&nbsp;definition&nbsp;of&nbsp;a&nbsp;generic&nbsp;counter&nbsp;with&nbsp;counting&nbsp;depending&nbsp;on&nbsp;thread&nbsp;calling&nbsp;it</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">TLScount</span><span class="oth">()</span>&nbsp;<span class="oth">+=</span>&nbsp;<span class="num">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'&nbsp;increment&nbsp;the&nbsp;TLS&nbsp;static&nbsp;integer</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="wrd">TLScount</span><span class="oth">()</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'&nbsp;return&nbsp;the&nbsp;TLS&nbsp;static&nbsp;integer</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">Thread</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">threadData</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">ptd</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UInteger</span>&nbsp;<span class="wrd">c</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#if&nbsp;__FB_VERSION__&nbsp;&lt;&nbsp;&quot;1.08&quot;<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">threadData.mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ThreadSelf</span><span class="oth">()</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">ptd</span><span class="oth">-&gt;</span><span class="wrd">handle</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#endif<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">c</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">counter</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#if&nbsp;__FB_VERSION__&nbsp;&lt;&nbsp;&quot;1.08&quot;<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">threadData.mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#endif<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="wrd">ptd</span><span class="oth">-&gt;</span><span class="wrd">prefix</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="wrd">c</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="wrd">ptd</span><span class="oth">-&gt;</span><span class="wrd">suffix</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="quo">&quot;&nbsp;&quot;</span><span class="oth">;</span>&nbsp;&nbsp;<span class="com">'&nbsp;single&nbsp;print&nbsp;with&nbsp;concatenated&nbsp;string&nbsp;avoids&nbsp;using&nbsp;a&nbsp;mutex</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="wrd">ptd</span><span class="oth">-&gt;</span><span class="wrd">tempo</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span>&nbsp;<span class="key">Until</span>&nbsp;<span class="wrd">c</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">12</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#if&nbsp;__FB_VERSION__&nbsp;&lt;&nbsp;&quot;1.08&quot;<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">threadData.mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ThreadSelf</span><span class="oth">()</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">ptd</span><span class="oth">-&gt;</span><span class="wrd">handle</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#endif<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">TLScount</span><span class="oth">(</span><span class="key">False</span><span class="oth">)</span>&nbsp;&nbsp;<span class="com">'&nbsp;destroy&nbsp;the&nbsp;TLS&nbsp;static&nbsp;integer</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#if&nbsp;__FB_VERSION__&nbsp;&lt;&nbsp;&quot;1.08&quot;<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">threadData.mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="def">#endif<br />
</span><span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="com">'------------------------------------------------------------------------------</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;|x|&nbsp;:&nbsp;counting&nbsp;from&nbsp;thread&nbsp;a&quot;</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;(x)&nbsp;:&nbsp;counting&nbsp;from&nbsp;thread&nbsp;b&quot;</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;[x]&nbsp;:&nbsp;counting&nbsp;from&nbsp;thread&nbsp;c&quot;</span><br />
<span class="key">Print</span><br />
<br />
<span class="def">#if&nbsp;__FB_VERSION__&nbsp;&lt;&nbsp;&quot;1.08&quot;<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">threadData.mutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><span class="oth">()</span><br />
<span class="def">#endif<br />
</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">threadData</span>&nbsp;<span class="wrd">mtlsa</span><br />
<span class="wrd">mtlsa.prefix</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;|&quot;</span><br />
<span class="wrd">mtlsa.suffix</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;|&quot;</span><br />
<span class="wrd">mtlsa.tempo</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">100</span><br />
<span class="def">#if&nbsp;__FB_VERSION__&nbsp;&lt;&nbsp;&quot;1.08&quot;<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">threadData.mutex</span><span class="oth">)</span><br />
<span class="def">#endif<br />
</span><span class="wrd">mtlsa.handle</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">Thread</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">mtlsa</span><span class="oth">)</span><br />
<span class="def">#if&nbsp;__FB_VERSION__&nbsp;&lt;&nbsp;&quot;1.08&quot;<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">threadData.mutex</span><span class="oth">)</span><br />
<span class="def">#endif<br />
</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">threadData</span>&nbsp;<span class="wrd">mtlsb</span><br />
<span class="wrd">mtlsb.prefix</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;(&quot;</span><br />
<span class="wrd">mtlsb.suffix</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;)&quot;</span><br />
<span class="wrd">mtlsb.tempo</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">150</span><br />
<span class="def">#if&nbsp;__FB_VERSION__&nbsp;&lt;&nbsp;&quot;1.08&quot;<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">threadData.mutex</span><span class="oth">)</span><br />
<span class="def">#endif<br />
</span><span class="wrd">mtlsb.handle</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">Thread</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">mtlsb</span><span class="oth">)</span><br />
<span class="def">#if&nbsp;__FB_VERSION__&nbsp;&lt;&nbsp;&quot;1.08&quot;<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">threadData.mutex</span><span class="oth">)</span><br />
<span class="def">#endif<br />
</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">threadData</span>&nbsp;<span class="wrd">mtlsc</span><br />
<span class="wrd">mtlsc.prefix</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;[&quot;</span><br />
<span class="wrd">mtlsc.suffix</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;]&quot;</span><br />
<span class="wrd">mtlsc.tempo</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">250</span><br />
<span class="def">#if&nbsp;__FB_VERSION__&nbsp;&lt;&nbsp;&quot;1.08&quot;<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">threadData.mutex</span><span class="oth">)</span><br />
<span class="def">#endif<br />
</span><span class="wrd">mtlsc.handle</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">Thread</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">mtlsc</span><span class="oth">)</span><br />
<span class="def">#if&nbsp;__FB_VERSION__&nbsp;&lt;&nbsp;&quot;1.08&quot;<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">threadData.mutex</span><span class="oth">)</span><br />
<span class="def">#endif<br />
</span><br />
<span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">mtlsa.handle</span><span class="oth">)</span><br />
<span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">mtlsb.handle</span><span class="oth">)</span><br />
<span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">mtlsc.handle</span><span class="oth">)</span><br />
<span class="def">#if&nbsp;__FB_VERSION__&nbsp;&lt;&nbsp;&quot;1.08&quot;<br />
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">threadData.mutex</span><span class="oth">)</span><br />
<span class="def">#endif<br />
</span><br />
<span class="key">Print</span><br />
<span class="key">Print</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;end&nbsp;of&nbsp;threads&quot;</span><br />
<br />
<span class="key">Sleep</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
Output example<br \>
<div class="fb_indent"><pre class="fb_pre">
|x| : counting from thread a
(x) : counting from thread b
[x] : counting from thread c

|1| (1) [1] |2| (2) |3| [2] (3) |4| |5| (4) [3] |6| (5) |7| [4] (6) |8| |9| (7) [5] |10| (8) |11| |12| (9) [6] (10) [7] (11) (12) [8] [9] [10] [11] [12]

end of threads
					</pre></div></div></div></div><div style="text-align: center;"><a href="#ProPgMtCriticalSectionsFAQtop">Back to top</a></div><br \>
<a name="ProPgMtCriticalSectionsFAQ13"></a><br \>
</div><div class="fb_sect_title">13. Can we emulate a kind of thread pooling feature with FreeBASIC?</div><div class="fb_sect_cont"><br \>
<ul><ul><li> Preamble:<br \>
</ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent">A thread pool is a set of threads that can be used to run tasks based on user needs.<br \>
The thread pool is accessible via a Type structure.<br \>
<br \>
Creating a new thread is an expensive act in terms of resources, both from a processor (CPU) point of view and from a memory point of view.<br \>
Also, in the event that a program requires the execution of many tasks, the creation and deletion of a thread for each of them would greatly penalize the performance of the application.<br \>
Therefore, it would be interesting to be able to share the creation of threads so that a thread that has finished executing a task is available for the execution of a future task.<br \>
<br \>
The objective of thread pooling is to pool the threads in order to avoid untimely creation or deletion of threads, and thus allow their reuse.<br \>
So when a task needs to be executed, it will be more resource efficient to check if the thread pool contains an available thread.<br \>
If so, it will be used while the task is running, and then freed when the task is completed.<br \>
If there is no thread available, a new thread can be created, and at the end of the task, the thread would be in turn available in the pool of threads.<br \>
<br \>
</div></div></div><ul><ul><li> Content:<br \>
</ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent">Two Type structures are first proposed below:<br \>
</div></div></div><ul><ul><ul><ul><ul><ul><li> ThreadInitThenMultiStart.<br \>
<li> ThreadPooling.<br \>
</ul></ul></ul></ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent">These two structures make it possible to use one thread per instance created, and to chain on this dedicated thread the execution of user procedures one after the other, but without the thread stopping between each:<br \>
<div class="fb_indent"><b>-</b> The 'ThreadInitThenMultiStart' structure requires a manual start after initialization (and manual wait for completion) for each user procedure to be executed in sequence in the thread.<br \>
<b>-</b> The 'ThreadPooling' structure allows to register a sequence of user thread procedure submissions in a queue, while at same time the user procedures start to be executed in the thread without waiting (a last registered wait command is enough to test for full sequence completion).<br \>
<br \>
</div>By creating and using several instances, these two structures make it possible to execute sequences of user procedures in several threads, therefore executed in parallel (temporally).<br \>
<br \>
A last structure is finally proposed:<br \>
</div></div></div><ul><ul><ul><ul><ul><ul><li> ThreadDispatching.<br \>
</ul></ul></ul></ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent">This last structure is an over-structure of the ThreadPooling structure, dispatching user thread procedures over a given max number of secondary threads.<br \>
<br \>
</div></div></div><ul><ul><li> <b>ThreadInitThenMultiStart</b> Type:<br \>
<ul><ul><li> Principle:<br \>
</ul></ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent">The 'ThreadInitThenMultiStart' Type below operationally provides to user 3 (4 actually) main public methods (plus a constructor and a destructor), and internally uses 9 private data members plus 1 private subroutine (static) member.<br \>
<br \>
The public methods are:<br \>
<div class="fb_indent"><b>-</b> ThreadInit : Initialize the instance with the parameters of the requested user procedure to be executed in a thread.<br \>
<b>-</b> ThreadStart : Start the user procedure execution in the thread (2 overload methods).<br \>
<b>-</b> ThreadWait : Wait for the completion of the user procedure in the thread.<br \>
<br \>
</div>By creating several instances each associated with a thread, we can obtain a kind of thread pooling feature.<br \>
The 'ThreadInitThenMultiStart' Type does not manage any pending thread queue.<br \>
It is up to the user to choose an existing instance or to create a new instance with which to run his thread procedure.<br \>
<br \>
</div></div></div></div></div><ul><ul><ul><ul><li> Description:<br \>
</ul></ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent">Each user procedure (to be executed in a thread) must be available under the following function signature:<br \>
<div class="fb_indent"><tt>Function userproc (Byval puserdata As Any Ptr) As String</tt><br \>
</div>in order to be compatible with the parameters of the 'ThreadInit' method:<br \>
<div class="fb_indent"><tt>Declare Sub ThreadInit (Byval pThread As Function (Byval As Any Ptr) As String, Byval p As Any Ptr = 0)</tt><br \>
</div>and perform the instance ('t') initialization by:<br \>
<div class="fb_indent"><tt>t.ThreadInit(@userproc [, puserdata])</tt><br \>
<br \>
</div>The other methods are called on the instance ('t'):<br \>
<div class="fb_indent"><tt>t.ThreadStart()</tt> or <tt>t.ThreadStart(puserdata)</tt><br \>
<tt>t.ThreadWait()</tt><br \>
<br \>
</div>The different methods must be called respecting the order of the following sequence:<br \>
<div class="fb_indent"><tt>ThreadInit, [user code,] ThreadStart, [user code,] ThreadWait, [user code,] ThreadStart, [user code,] ThreadWait, [user code,] .....</tt><br \>
<br \>
</div>After any 'ThreadStart'...'ThreadWait' sequence, a new user thread procedure can be initialized by calling the 'ThreadInit' method again on the same instance.<br \>
On the other hand, 'ThreadStart'...'ThreadWait' sequences can also be chained on different instances already initialized.<br \>
If using several instances (so several threads), the ordered sequences on each instance can be interlaced between instances because calling methods on different instances.<br \>
The overload method 'ThreadStart(Byval p As Any Ptr)' allows to start the user thread procedure by specifying a new parameter value, without having to call 'ThreadInit' first. The overload method 'ThreadStart()' starts the user thread procedure without modifying the parameter value.<br \>
<br \>
The 'ThreadWait' method returns a 'As String' Type (by value), like the user thread function is declared (a string variable return allows to also pass a numeric value).<br \>
<br \>
This user data return from the user function is accessed through the 'ThreadWait' return. It is always safe (because in this case, the user thread function has been always fully executed).<br \>
If the user doesn't want to use the return value of its thread function (to be used like for a subroutine):<br \>
<div class="fb_indent"><b>-</b> He ends his user thread function with <tt>Return </tt><tt>"</tt><tt>"</tt> for example.<br \>
<b>-</b> He calls 'ThreadWait' as a subroutine and not as a function (not accessing the value potentially returned by 'ThreadWait').<br \>
<br \>
</div><b>Warning:</b> The information supplied to the user thread procedure via the passed pointer (by 'ThreadInit' or 'ThreadStart') should not be changed between 'ThreadStart' and 'ThreadWait' due to the time uncertainty on the real call of the user thread procedure in this interval.<br \>
<br \>
</div></div></div></div></div><ul><ul><ul><ul><li> Under the hood:<br \>
</ul></ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent">In fact, each instance is associated with an internal thread that runs continuously in a loop as soon as a first initialization ('ThreadInit') has taken place. This internal thread runs the private subroutine (static) member.<br \>
It is this private subroutine (static) member that will call (on a 'ThreadStart') the user procedure to be executed, like a classic function call. The value returned by the user function is stored to be subsequently returned to the user through the returned value by 'ThreadWait'.<br \>
<br \>
So, for each new 'ThreadInitThenMultiStart' instance, an internal thread is started on the first 'ThreadInit' method (calling the 'ThreadCreate' FreeBASIC keyword), then the user thread procedure is started on the 'ThreadStart' method request.<br \>
As each initialized instance is associated with a running internal thread, using local scopes or dynamic instances allow to stop internal threads that are no longer used.<br \>
<br \>
In the 'ThreadInitThenMultiStart' Type, an additional property 'ThreadState' is available to returns (in a Ubyte) the current internal state of the process.<br \>
This property allows to sample at any time the state of the internal thread.<br \>
This property can also be used during the debugging phase (allowing in addition to identify the case of blocking in the user thread procedure running).<br \>
<br \>
ThreadState:<br \>
<div class="fb_indent">0 -&gt; disabled (internal thread stopped, waiting for 'ThreadInit')<br \>
1 -&gt; available (waiting for 'ThreadStart' or another 'ThreadInit')<br \>
2 -&gt; busy (user thread procedure running)<br \>
4 -&gt; completing (user thread procedure completed, but waiting for 'ThreadWait')<br \>
<br \>
</div>Internally, the Type uses 3 mutexes (by self locking and mutual unlocking) to ensure the ordered sequence of methods called as defined above and wait for the end of the user thread function or for a new user thread function to call.<br \>
So, no waiting loop is used in the methods coding but only mutexes locking/unlocking requests, so that the halted thread (on a mutex to be locked) has its execution suspended and does not consume any CPU time until the mutex is unlocked.<br \>
The constructor is responsible for creating and locking the 3 mutexes, while the destructor stops the thread (if it exists) then destroys the 3 mutexes.<br \>
<br \>
<b>Note:</b> An advised user can stop the internal thread (linked to instance 't') by using the non-breaking sequence: <tt>t.Destructor() : t.Constructor()</tt>. Then a <tt>t.ThreadInit(...)</tt> is necessary to start a new internal thread.<br \>
<br \>
</div></div></div></div></div><ul><ul><ul><ul><li> Example:<br \>
</ul></ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent">Chronology of the user code:<br \>
<div class="fb_indent"><b>-</b> A single 'ThreadInitThenMultiStart' instance is created in order to use a single thread.<br \>
<b>-</b> The instance is initialized ('ThreadInit') with a first user thread function: 'UserThreadS' (internal thread creation by using the 'ThreadCreate' FreeBASIC keyword).<br \>
<b>-</b> A sequence of 9 'ThreadStart...ThreadWait' is requested for this first user thread function, used like a thread subroutine.<br \>
<b>-</b> The same instance is reinitialized ('ThreadInit') with a second user thread function: 'UserThreadF' (the previous pending thread will be reused).<br \>
<b>-</b> A sequence of 9 'ThreadStart...ThreadWait' is also requested for this second user thread function, used like a thread function.<br \>
<br \>
</div>Full code with the 'ThreadInitThenMultiStart' Type:<br \>
<div class="fb_indent"><tt><div class="freebasic">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Type</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Public</span><span class="oth">:</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Constructor</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadInit</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">pThread</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadStart</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadStart</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Function</span>&nbsp;<span class="key">ThreadWait</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Property</span>&nbsp;<span class="wrd">ThreadState</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UByte</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Destructor</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Private</span><span class="oth">:</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">_pThread</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_mutex1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_mutex2</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_mutex3</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_pt</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Byte</span>&nbsp;<span class="wrd">_end</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">_returnF</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UByte</span>&nbsp;<span class="wrd">_state</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">_Thread</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">Type</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Constructor</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._mutex1</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._mutex2</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._mutex3</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex3</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">Constructor</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart.ThreadInit</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">pThread</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._pThread</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">pThread</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._p</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">This._pt</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._pt</span><span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">ThreadInitThenMultiStart._Thread</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="key">This</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex3</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart.ThreadStart</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex3</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart.ThreadStart</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex3</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._p</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Function</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart.ThreadWait</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex3</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="wrd">This._returnF</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Property</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart.ThreadState</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UByte</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="wrd">This._state</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">Property</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart._Thread</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">pThis</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_mutex1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_end</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">Then</span>&nbsp;<span class="key">Exit</span>&nbsp;<span class="key">Sub</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">2</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_returnF</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">4</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_mutex2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Destructor</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">This._pt</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._end</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">This._pt</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">This._mutex1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">This._mutex2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">This._mutex3</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">Destructor</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">'---------------------------------------------------</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Function</span>&nbsp;<span class="wrd">UserThreadS</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UInteger</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">pui</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="oth">*</span><span class="wrd">pui</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="oth">*</span><span class="wrd">pui</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="quo">&quot;&quot;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Function</span>&nbsp;<span class="wrd">UserThreadF</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UInteger</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">pui</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UInteger</span>&nbsp;<span class="wrd">c</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="oth">(*</span><span class="wrd">pui</span><span class="oth">)</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="oth">(*</span><span class="wrd">pui</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="key">Str</span><span class="oth">(</span><span class="wrd">c</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart</span>&nbsp;<span class="wrd">t</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;First&nbsp;user&nbsp;function&nbsp;executed&nbsp;like&nbsp;a&nbsp;thread&nbsp;subroutine:&quot;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">t.ThreadInit</span><span class="oth">(@</span><span class="wrd">UserThreadS</span><span class="oth">)</span>&nbsp;&nbsp;<span class="com">''&nbsp;initializes&nbsp;the&nbsp;user&nbsp;thread&nbsp;function&nbsp;(used&nbsp;as&nbsp;subroutine)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UInteger</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">9</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="quo">&quot;^2&nbsp;=&nbsp;&quot;</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">t.ThreadStart</span><span class="oth">(@</span><span class="wrd">I</span><span class="oth">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">''&nbsp;starts&nbsp;the&nbsp;user&nbsp;thread&nbsp;procedure&nbsp;code&nbsp;body</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">t.Threadwait</span><span class="oth">()</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">''&nbsp;waits&nbsp;for&nbsp;the&nbsp;user&nbsp;thread&nbsp;procedure&nbsp;code&nbsp;end</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;Second&nbsp;user&nbsp;function&nbsp;executed&nbsp;like&nbsp;a&nbsp;thread&nbsp;function:&quot;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">t.ThreadInit</span><span class="oth">(@</span><span class="wrd">UserThreadF</span><span class="oth">)</span>&nbsp;&nbsp;<span class="com">''&nbsp;initializes&nbsp;the&nbsp;user&nbsp;thread&nbsp;function&nbsp;(used&nbsp;as&nbsp;function)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UInteger</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">9</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="quo">&quot;^2&nbsp;=&nbsp;&quot;</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">t.ThreadStart</span><span class="oth">(@</span><span class="wrd">I</span><span class="oth">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">''&nbsp;starts&nbsp;the&nbsp;user&nbsp;thread&nbsp;procedure&nbsp;code&nbsp;body</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="wrd">t.Threadwait</span><span class="oth">()</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="com">''&nbsp;waits&nbsp;for&nbsp;the&nbsp;user&nbsp;thread&nbsp;procedure&nbsp;code&nbsp;end&nbsp;and&nbsp;prints&nbsp;result</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
Output:<br \>
<div class="fb_indent"><pre class="fb_pre">
First user function executed like a thread subroutine:
1^2 = 1
2^2 = 4
3^2 = 9
4^2 = 16
5^2 = 25
6^2 = 36
7^2 = 49
8^2 = 64
9^2 = 81

Second user function executed like a thread function:
1^2 = 1
2^2 = 4
3^2 = 9
4^2 = 16
5^2 = 25
6^2 = 36
7^2 = 49
8^2 = 64
9^2 = 81
								</pre></div></div></div></div></div></div></div><ul><ul><li> <b>ThreadPooling</b> Type:<br \>
<ul><ul><li> Principle:<br \>
</ul></ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent">The 'ThreadPooling' Type below operationally provides to user 2 (3 actually) main public methods (plus a constructor and a destructor), and internally uses 11 private data members plus 1 private subroutine (static) member.<br \>
<br \>
The public methods are:<br \>
<div class="fb_indent"><b>-</b> PoolingSubmit : Enter a user thread procedure in the queue.<br \>
<b>-</b> PoolingWait : Wait for full emptying of the queue (with last user procedure executed).<br \>
<br \>
</div>By creating several instances each associated with a thread, we can obtain a kind of thread pooling feature.<br \>
The 'ThreadPooling' Type manages a pending thread queue by instance (so, by thread).<br \>
It is up to the user to choose an existing instance or to create a new instance with which to run his thread procedure sequence.<br \>
<br \>
On each 'ThreadPooling' Type instance, the submitted user thread procedures are immediately entered in a queue specific to the instance.<br \>
These buffered user thread procedures are sequentially as soon as possible executed in the thread dedicated to the instance.<br \>
<br \>
</div></div></div></div></div><ul><ul><ul><ul><li> Description:<br \>
</ul></ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent">Each user procedure (to be executed in a thread) must be available under the following function signature:<br \>
<tt>Function userproc (Byval puserdata As Any Ptr) As String</tt><br \>
in order to be compatible with the parameters of the 'PoolingSubmit()' method:<br \>
<tt>Declare Sub PoolingSubmit (Byval pThread As Function (Byval As Any Ptr) As String, Byval p As Any Ptr = 0)</tt><br \>
and perform the instance ('t') submission in the queue by:<br \>
<tt>t.PoolingSubmit(@userproc [, puserdata])</tt><br \>
<br \>
The other method is called on the instance ('t'):<br \>
<tt>t.PoolingWait() or t.PoolingWait(returndata())</tt><br \>
<br \>
The different methods must be called respecting the order of the following sequence:<br \>
<tt>PoolingSubmit, [user code,] [PoolingSubmit, [user code,] [PoolingSubmit, [user code, ...]] PoolingWait, [user code,] ...</tt><br \>
<br \>
After any 'PoolingSubmit'...'PoolingWait' sequence, a new user thread procedure sequence can be submitted by calling another 'PoolingSubmit'...'PoolingWait' sequence again on the same instance.<br \>
On the other hand, 'PoolingSubmit'...'PoolingWait' sequences can also be chained on different instances already initialized.<br \>
If using several instances (so several threads), the ordered sequences on each instance can be interlaced between instances because calling methods on different instances.<br \>
<br \>
The 'PoolingWait(returndata())' method fills in a String array with the user thread function returns (a string variable return allows to also pass a numeric value).<br \>
These user data returns from the user functions is accessed through the argument of 'PoolingWait(returndata())' method. It is always safe (because in this case, the user thread functions has been always fully executed).<br \>
If the user doesn't want to use the return values of its thread functions (to be used like for subroutines):<br \>
<div class="fb_indent"><b>-</b> He ends his user thread functions with <tt>Return </tt><tt>"</tt><tt>"</tt> for example.<br \>
<b>-</b> He calls the 'PoolingWait()' method without parameter.<br \>
<br \>
</div><b>Warning:</b> The information supplied to the user thread procedure via the passed pointer (by 'PoolingSubmit') should not be changed between 'PoolingSubmit' and 'PoolingWait' due to the time uncertainty on the real call of the user thread procedure in this interval.<br \>
<br \>
</div></div></div></div></div><ul><ul><ul><ul><li> Under the hood:<br \>
</ul></ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent">In fact, each instance is associated with an internal thread that runs continuously in a loop as soon as the instance is constructed. This internal thread runs the private subroutine (static) member.<br \>
It is this private subroutine (static) member that will call the user procedures of the sequence to be executed, like classic function calls. The value returned by each user function is stored in an internal string array to be finally returned to the user through the argument of 'PoolingWait(returndata())'.<br \>
<br \>
So, for each new 'ThreadPooling' instance, an internal thread is started by the constructor, then each user thread procedure is started on each dequeuing of the registered submissions.<br \>
As each initialized instance is associated with a running internal thread, using local scopes or dynamic instances allow to stop internal threads that are no longer used.<br \>
<br \>
In the 'ThreadPooling' Type, an additional property 'PoolingState' is available to returns (in a Ubyte) the current internal state of the process.<br \>
This property allows to sample at any time the state of the internal thread.<br \>
This property can also be used during the debugging phase (allowing in addition to identify the case of blocking in the user thread procedure running).<br \>
<br \>
PoolingState:<br \>
<div class="fb_indent">0 -&gt; User thread procedures sequence execution completed (after 'PoolingWait' acknowledge or new instance creation)<br \>
1 -&gt; Beginning of user thread procedure sequence submitted but no still executing (after first 'PoolingSubmit')<br \>
2 -&gt; User thread procedure running<br \>
4 -&gt; User thread procedure sequence execution pending (for 'PoolingWait' acknowledge or new user thread procedure submission)<br \>
<br \>
</div>An overload method 'PoolingWait(values() As String)' is added.<br \>
'PoolingWait(values()' As String) fills out a user-supplied dynamic array with the return value sequence from the latest user thread functions (then internally clear these same supplied return data).<br \>
The other overload method 'PoolingWait()' (without passed parameter) also clears the internal return values.<br \>
<br \>
'ThreadPooling' Type allows to manage kind of "FIFOs" (First In First Out) via dynamic arrays:<br \>
<div class="fb_indent"><b>-</b> Arrays are filled in as user submissions (from the main thread).<br \>
<b>-</b> Arrays are automatically emptied on the fly by the secondary thread which executes their requests as and when.<br \>
<b>-</b> So, the inputs and outputs of the "FIFOs" are therefore asynchronous with an optimized throughput on each side.<br \>
<br \>
</div>With 'ThreadPooling' the execution time of a 'PoolingSubmit' method in the main thread, corresponds only to the time spent to register the user procedure submission.<br \>
<br \>
It is necessary to be able to do (for the 'PoolingSubmit', 'PoolingWait' and 'Destructeur' methods, all in competition with '_Thread' subroutine) atomic mutex unlockings, which is not possible with simple mutexlocks / mutexunlocks.<br \>
This therefore requires the use of conditional variables (condwait / condsignal).<br \>
<br \>
The constructor is responsible for creating the 2 conditional variables and the associated mutex, while the destructor stops the thread then destroys the 2 conditional variables and the associated mutex.<br \>
<br \>
</div></div></div></div></div><ul><ul><ul><ul><li> Example:<br \>
</ul></ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent">Chronology of the user code:<br \>
<div class="fb_indent"><b>-</b> A single 'ThreadPooling' instance is created in order to use a single thread.<br \>
<b>-</b> A first sequence (a) of 3 'PoolingSubmit' is requested for the first three user thread functions, ended by a 'PoolingWait' without parameter.<br \>
<b>-</b> A second sequence (b) of 3 'PoolingSubmit' is requested for the last three user thread functions, ended by a 'PoolingWait' with a dynamic string array as argument (so, only the returns from the last three user thread functions will fill out in the dynamic string array).<br \>
<br \>
</div>Full code with the 'ThreadPooling' Type:<br \>
<div class="fb_indent"><tt><div class="freebasic">
<span class="def">#include&nbsp;Once&nbsp;&quot;crt/string.bi&quot;<br />
</span><span class="key">Type</span>&nbsp;<span class="wrd">ThreadPooling</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Public</span><span class="oth">:</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Constructor</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">PoolingSubmit</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">pThread</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">PoolingWait</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">PoolingWait</span><span class="oth">(</span><span class="wrd">values</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Property</span>&nbsp;<span class="wrd">PoolingState</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UByte</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Destructor</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Private</span><span class="oth">:</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">_pThread0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_p0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">_pThread</span><span class="oth">(</span><span class="key">Any</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_p</span><span class="oth">(</span><span class="key">Any</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_mutex</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_cond1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_cond2</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_pt</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Byte</span>&nbsp;<span class="wrd">_end</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">_returnF</span><span class="oth">(</span><span class="key">Any</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UByte</span>&nbsp;<span class="wrd">_state</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">_Thread</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Type</span><br />
<br />
<span class="key">Constructor</span>&nbsp;<span class="wrd">ThreadPooling</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="wrd">This._pThread</span><span class="oth">(</span><span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="wrd">This._p</span><span class="oth">(</span><span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="wrd">This._returnF</span><span class="oth">(</span><span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._mutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._cond1</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">CondCreate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._cond2</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">CondCreate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._pt</span><span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">ThreadPooling._Thread</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="key">This</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Constructor</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadPooling.PoolingSubmit</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">pThread</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">This._pThread</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._pThread</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._pThread</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._pThread</span><span class="oth">))</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">pThread</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">This._p</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._p</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._p</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._p</span><span class="oth">))</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondSignal</span><span class="oth">(</span><span class="wrd">This._cond2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadPooling.PoolingWait</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">While</span>&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="num">4</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondWait</span><span class="oth">(</span><span class="wrd">This._Cond1</span><span class="oth">,</span>&nbsp;<span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Wend</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="wrd">This._returnF</span><span class="oth">(</span><span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadPooling.PoolingWait</span><span class="oth">(</span><span class="wrd">values</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">While</span>&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="num">4</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondWait</span><span class="oth">(</span><span class="wrd">This._Cond1</span><span class="oth">,</span>&nbsp;<span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Wend</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._returnF</span><span class="oth">)</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="wrd">values</span><span class="oth">(</span><span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._returnF</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._returnF</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">values</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">This._returnF</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="wrd">This._returnF</span><span class="oth">(</span><span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Else</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Erase</span>&nbsp;<span class="wrd">values</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Property</span>&nbsp;<span class="wrd">ThreadPooling.PoolingState</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UByte</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="wrd">This._state</span><br />
<span class="key">End</span>&nbsp;<span class="key">Property</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadPooling._Thread</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">ThreadPooling</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">pThis</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">4</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondSignal</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_cond1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">While</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondWait</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_cond2</span><span class="oth">,</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_end</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">Then</span>&nbsp;<span class="key">Exit</span>&nbsp;<span class="key">Sub</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Wend</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread0</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">(</span><span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p0</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">(</span><span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">)</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">memmove</span><span class="oth">(@</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">(</span><span class="num">1</span><span class="oth">),</span>&nbsp;<span class="oth">@</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">(</span><span class="num">2</span><span class="oth">),</span>&nbsp;<span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">)</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><span class="oth">)</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">SizeOf</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">memmove</span><span class="oth">(@</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">(</span><span class="num">1</span><span class="oth">),</span>&nbsp;<span class="oth">@</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">(</span><span class="num">2</span><span class="oth">),</span>&nbsp;<span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">)</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><span class="oth">)</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">SizeOf</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">)</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">)</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_ReturnF</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_returnF</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">2</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_returnF</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_returnF</span><span class="oth">))</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread0</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Destructor</span>&nbsp;<span class="wrd">ThreadPooling</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._end</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondSignal</span><span class="oth">(</span><span class="wrd">This._cond2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">This._pt</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondDestroy</span><span class="oth">(</span><span class="wrd">This._cond1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondDestroy</span><span class="oth">(</span><span class="wrd">This._cond2</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Destructor</span><br />
<br />
<span class="com">'---------------------------------------------------</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">Prnt</span>&nbsp;<span class="oth">(</span><span class="key">ByRef</span>&nbsp;<span class="wrd">s</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">ps</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">ps</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span>&nbsp;<span class="key">Print</span>&nbsp;<span class="oth">*</span><span class="wrd">ps</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">10</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="wrd">s</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">UserCode1</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">Prnt</span><span class="oth">(</span><span class="quo">&quot;1&quot;</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="quo">&quot;UserCode&nbsp;#1&quot;</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">UserCode2</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">Prnt</span><span class="oth">(</span><span class="quo">&quot;2&quot;</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="quo">&quot;UserCode&nbsp;#2&quot;</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">UserCode3</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">Prnt</span><span class="oth">(</span><span class="quo">&quot;3&quot;</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="quo">&quot;UserCode&nbsp;#3&quot;</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">UserCode4</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">Prnt</span><span class="oth">(</span><span class="quo">&quot;4&quot;</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="quo">&quot;UserCode&nbsp;#4&quot;</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">UserCode5</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">Prnt</span><span class="oth">(</span><span class="quo">&quot;5&quot;</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="quo">&quot;UserCode&nbsp;#5&quot;</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">UserCode6</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">Prnt</span><span class="oth">(</span><span class="quo">&quot;6&quot;</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="quo">&quot;UserCode&nbsp;#6&quot;</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">sa</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;Sequence&nbsp;#a:&nbsp;&quot;</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">sb</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;Sequence&nbsp;#b:&nbsp;&quot;</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">s</span><span class="oth">()</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">ThreadPooling</span>&nbsp;<span class="wrd">t</span><br />
<br />
<span class="wrd">t.PoolingSubmit</span><span class="oth">(@</span><span class="wrd">UserCode1</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">sa</span><span class="oth">)</span><br />
<span class="wrd">t.PoolingSubmit</span><span class="oth">(@</span><span class="wrd">UserCode2</span><span class="oth">)</span><br />
<span class="wrd">t.PoolingSubmit</span><span class="oth">(@</span><span class="wrd">UserCode3</span><span class="oth">)</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;Sequence&nbsp;#a&nbsp;of&nbsp;3&nbsp;user&nbsp;thread&nbsp;functions&nbsp;fully&nbsp;submitted&nbsp;&quot;</span><br />
<span class="wrd">t.PoolingWait</span><span class="oth">()</span><br />
<span class="key">Print</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;Sequence&nbsp;#a&nbsp;completed&quot;</span><br />
<span class="key">Print</span><br />
<br />
<span class="wrd">t.PoolingSubmit</span><span class="oth">(@</span><span class="wrd">UserCode4</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">sb</span><span class="oth">)</span><br />
<span class="wrd">t.PoolingSubmit</span><span class="oth">(@</span><span class="wrd">UserCode5</span><span class="oth">)</span><br />
<span class="wrd">t.PoolingSubmit</span><span class="oth">(@</span><span class="wrd">UserCode6</span><span class="oth">)</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;Sequence&nbsp;#b&nbsp;of&nbsp;3&nbsp;user&nbsp;thread&nbsp;functions&nbsp;fully&nbsp;submitted&nbsp;&quot;</span><br />
<span class="wrd">t.PoolingWait</span><span class="oth">(</span><span class="wrd">s</span><span class="oth">())</span><br />
<span class="key">Print</span><br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;Sequence&nbsp;#b&nbsp;completed&quot;</span><br />
<span class="key">Print</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;List&nbsp;of&nbsp;returned&nbsp;values&nbsp;from&nbsp;sequence&nbsp;#b&nbsp;only&quot;</span><br />
<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">LBound</span><span class="oth">(</span><span class="wrd">s</span><span class="oth">)</span>&nbsp;<span class="key">To</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">s</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;&quot;</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="quo">&quot;:&nbsp;&quot;</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="wrd">s</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span><br />
<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="key">Print</span><br />
<br />
<span class="key">Sleep</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
Output example<br \>
<div class="fb_indent"><pre class="fb_pre">
 Sequence #a of 3 user thread functions fully submitted
  Sequence #a: 111111111122222222223333333333
 Sequence #a completed

 Sequence #b of 3 user thread functions fully submitted
  Sequence #b: 444444444455555555556666666666
 Sequence #b completed

 List of returned values from sequence #b only
  1: UserCode #4
  2: UserCode #5
  3: UserCode #6
								</pre>Note: If the first user thread procedure of each sequence starts very quickly, the acknowledgement message of each sequence of 3 submissions may appear inserted after the beginning of the text printed by the first user procedure of the sequence.<br \>
That is not the case here.<br \>
<br \>
</div></div></div></div></div></div></div><ul><ul><li> <b>ThreadInitThenMultiStart</b> and <b>ThreadPooling</b> Types<br \>
<ul><ul><li> Execution time gain checking with different multi-threading configurations:<br \>
</ul></ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent">A user task is defined:<br \>
<div class="fb_indent"><b>-</b> Display 64 characters (2*32) on the screen, each separated by an identical time achieved by a <tt>[For ... Next]</tt> loop (no Sleep keyword so as not to free up CPU resources).<br \>
<b>-</b> Depending on the number of threads chosen 1/2/4/8/16/32, this same user task is split in 1/2/4/8/16/32 sub-tasks, each being executed on a thread.<br \>
<br \>
</div>Full code with the 'ThreadInitThenMultiStart' and 'ThreadPooling' Types:<br \>
<div class="fb_indent"><tt><div class="freebasic">
<span class="key">Type</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Public</span><span class="oth">:</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Constructor</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadInit</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">pThread</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadStart</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadStart</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Function</span>&nbsp;<span class="key">ThreadWait</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Property</span>&nbsp;<span class="wrd">ThreadState</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UByte</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Destructor</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Private</span><span class="oth">:</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">_pThread</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_mutex1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_mutex2</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_mutex3</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_pt</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Byte</span>&nbsp;<span class="wrd">_end</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">_returnF</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UByte</span>&nbsp;<span class="wrd">_state</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">_Thread</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Type</span><br />
<br />
<span class="key">Constructor</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._mutex1</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._mutex2</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._mutex3</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex3</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Constructor</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart.ThreadInit</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">pThread</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._pThread</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">pThread</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._p</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">This._pt</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._pt</span><span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">ThreadInitThenMultiStart._Thread</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="key">This</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex3</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart.ThreadStart</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex3</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex1</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart.ThreadStart</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex3</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._p</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex1</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart.ThreadWait</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex3</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="wrd">This._returnF</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Property</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart.ThreadState</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UByte</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="wrd">This._state</span><br />
<span class="key">End</span>&nbsp;<span class="key">Property</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart._Thread</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">pThis</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_mutex1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_end</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">Then</span>&nbsp;<span class="key">Exit</span>&nbsp;<span class="key">Sub</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">2</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_returnF</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">4</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_mutex2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Destructor</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">This._pt</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._end</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">This._pt</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">This._mutex1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">This._mutex2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">This._mutex3</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Destructor</span><br />
<br />
<span class="com">'---------------------------------------------------</span><br />
<br />
<span class="def">#include&nbsp;Once&nbsp;&quot;crt/string.bi&quot;<br />
</span><span class="key">Type</span>&nbsp;<span class="wrd">ThreadPooling</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Public</span><span class="oth">:</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Constructor</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">PoolingSubmit</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">pThread</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">PoolingWait</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">PoolingWait</span><span class="oth">(</span><span class="wrd">values</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Property</span>&nbsp;<span class="wrd">PoolingState</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UByte</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Destructor</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Private</span><span class="oth">:</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">_pThread0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_p0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">_pThread</span><span class="oth">(</span><span class="key">Any</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_p</span><span class="oth">(</span><span class="key">Any</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_mutex</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_cond1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_cond2</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_pt</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Byte</span>&nbsp;<span class="wrd">_end</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">_returnF</span><span class="oth">(</span><span class="key">Any</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UByte</span>&nbsp;<span class="wrd">_state</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">_Thread</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Type</span><br />
<br />
<span class="key">Constructor</span>&nbsp;<span class="wrd">ThreadPooling</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="wrd">This._pThread</span><span class="oth">(</span><span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="wrd">This._p</span><span class="oth">(</span><span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="wrd">This._returnF</span><span class="oth">(</span><span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._mutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._cond1</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">CondCreate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._cond2</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">CondCreate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._pt</span><span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">ThreadPooling._Thread</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="key">This</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Constructor</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadPooling.PoolingSubmit</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">pThread</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">This._pThread</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._pThread</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._pThread</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._pThread</span><span class="oth">))</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">pThread</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">This._p</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._p</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._p</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._p</span><span class="oth">))</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondSignal</span><span class="oth">(</span><span class="wrd">This._cond2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadPooling.PoolingWait</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">While</span>&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="num">4</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondWait</span><span class="oth">(</span><span class="wrd">This._Cond1</span><span class="oth">,</span>&nbsp;<span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Wend</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="wrd">This._returnF</span><span class="oth">(</span><span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadPooling.PoolingWait</span><span class="oth">(</span><span class="wrd">values</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">While</span>&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="num">4</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondWait</span><span class="oth">(</span><span class="wrd">This._Cond1</span><span class="oth">,</span>&nbsp;<span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Wend</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._returnF</span><span class="oth">)</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="wrd">values</span><span class="oth">(</span><span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._returnF</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._returnF</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">values</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">This._returnF</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="wrd">This._returnF</span><span class="oth">(</span><span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Else</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Erase</span>&nbsp;<span class="wrd">values</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Property</span>&nbsp;<span class="wrd">ThreadPooling.PoolingState</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UByte</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="wrd">This._state</span><br />
<span class="key">End</span>&nbsp;<span class="key">Property</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadPooling._Thread</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">ThreadPooling</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">pThis</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">4</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondSignal</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_cond1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">While</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondWait</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_cond2</span><span class="oth">,</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_end</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">Then</span>&nbsp;<span class="key">Exit</span>&nbsp;<span class="key">Sub</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Wend</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread0</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">(</span><span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p0</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">(</span><span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">)</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">memmove</span><span class="oth">(@</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">(</span><span class="num">1</span><span class="oth">),</span>&nbsp;<span class="oth">@</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">(</span><span class="num">2</span><span class="oth">),</span>&nbsp;<span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">)</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><span class="oth">)</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">SizeOf</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">memmove</span><span class="oth">(@</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">(</span><span class="num">1</span><span class="oth">),</span>&nbsp;<span class="oth">@</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">(</span><span class="num">2</span><span class="oth">),</span>&nbsp;<span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">)</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><span class="oth">)</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">SizeOf</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">)</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">)</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_ReturnF</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_returnF</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">2</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_returnF</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_returnF</span><span class="oth">))</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread0</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Destructor</span>&nbsp;<span class="wrd">ThreadPooling</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._end</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondSignal</span><span class="oth">(</span><span class="wrd">This._cond2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">This._pt</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondDestroy</span><span class="oth">(</span><span class="wrd">This._cond1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondDestroy</span><span class="oth">(</span><span class="wrd">This._cond2</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Destructor</span><br />
<br />
<span class="com">'---------------------------------------------------</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">Shared</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Double</span>&nbsp;<span class="wrd">array</span><span class="oth">(</span><span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">800000</span><span class="oth">)</span>&nbsp;&nbsp;<span class="com">''&nbsp;only&nbsp;used&nbsp;by&nbsp;the&nbsp;[For...Next]&nbsp;waiting&nbsp;loop&nbsp;in&nbsp;UserCode()</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">UserCode</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">ps</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">2</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="oth">*</span><span class="wrd">ps</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">J</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">800000</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">array</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Tan</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">Atn</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">Exp</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">Log</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span>&nbsp;&nbsp;<span class="com">''&nbsp;[For...Next]&nbsp;waiting&nbsp;loop&nbsp;not&nbsp;freeing&nbsp;any&nbsp;CPU&nbsp;resource</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">J</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="quo">&quot;&quot;</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">s</span><span class="oth">(</span><span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">31</span><span class="oth">)</span><br />
<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">15</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">s</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Str</span><span class="oth">(</span><span class="key">Hex</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">))</span><br />
<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">16</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">31</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">s</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Chr</span><span class="oth">(</span><span class="num">55</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="wrd">I</span><span class="oth">)</span><br />
<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<br />
<span class="com">'---------------------------------------------------</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">ThreadInitThenMultiStart</span>&nbsp;<span class="wrd">ts</span><span class="oth">(</span><span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">31</span><span class="oth">)</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">ThreadPooling</span>&nbsp;<span class="wrd">tp</span><span class="oth">(</span><span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">31</span><span class="oth">)</span><br />
<br />
<span class="com">'---------------------------------------------------</span><br />
<br />
<span class="def">#macro&nbsp;ThreadInitThenMultiStartSequence(nbThread)<br />
</span><span class="key">Scope</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Double</span>&nbsp;<span class="wrd">t</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Timer</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;&nbsp;&quot;</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">32</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="wrd">nbThread</span>&nbsp;<span class="key">Step</span>&nbsp;<span class="wrd">nbThread</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">J</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">nbThread</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">ts</span><span class="oth">(</span><span class="wrd">J</span><span class="oth">).</span><span class="wrd">ThreadInit</span><span class="oth">(@</span><span class="wrd">UserCode</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">s</span><span class="oth">(</span><span class="wrd">I</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="wrd">J</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">ts</span><span class="oth">(</span><span class="wrd">J</span><span class="oth">).</span><span class="wrd">ThreadStart</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">J</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">J</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">nbThread</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">ts</span><span class="oth">(</span><span class="wrd">J</span><span class="oth">).</span><span class="key">ThreadWait</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">J</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">t</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Timer</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="wrd">t</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="key">Using</span>&nbsp;<span class="quo">&quot;&nbsp;:&nbsp;####.##&nbsp;s&quot;</span><span class="oth">;</span>&nbsp;<span class="wrd">t</span><br />
<span class="key">End</span>&nbsp;<span class="key">Scope</span><br />
<span class="def">#endmacro<br />
</span><br />
<span class="def">#macro&nbsp;ThreadPoolingSequence(nbThread)<br />
</span><span class="key">Scope</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Double</span>&nbsp;<span class="wrd">t</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Timer</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;&nbsp;&quot;</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">32</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="wrd">nbThread</span>&nbsp;<span class="key">Step</span>&nbsp;<span class="wrd">nbThread</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">J</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">nbThread</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">tp</span><span class="oth">(</span><span class="wrd">J</span><span class="oth">).</span><span class="wrd">PoolingSubmit</span><span class="oth">(@</span><span class="wrd">UserCode</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">s</span><span class="oth">(</span><span class="wrd">I</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="wrd">J</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">J</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="wrd">nbThread</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">tp</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">).</span><span class="wrd">PoolingWait</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">t</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">Timer</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="wrd">t</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="key">Using</span>&nbsp;<span class="quo">&quot;&nbsp;:&nbsp;####.##&nbsp;s&quot;</span><span class="oth">;</span>&nbsp;<span class="wrd">t</span><br />
<span class="key">End</span>&nbsp;<span class="key">Scope</span><br />
<span class="def">#endmacro<br />
</span><br />
<span class="com">'---------------------------------------------------</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;'ThreadInitThenMultiStart'&nbsp;with&nbsp;1&nbsp;secondary&nbsp;thread:&quot;</span><br />
<span class="wrd">ThreadInitThenMultiStartSequence</span><span class="oth">(</span><span class="num">1</span><span class="oth">)</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;'ThreadPooling'&nbsp;with&nbsp;1&nbsp;secondary&nbsp;thread:&quot;</span><br />
<span class="wrd">ThreadPoolingSequence</span><span class="oth">(</span><span class="num">1</span><span class="oth">)</span><br />
<span class="key">Print</span><br />
<br />
<span class="com">'---------------------------------------------------</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;'ThreadInitThenMultiStart'&nbsp;with&nbsp;2&nbsp;secondary&nbsp;threads:&quot;</span><br />
<span class="wrd">ThreadInitThenMultiStartSequence</span><span class="oth">(</span><span class="num">2</span><span class="oth">)</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;'ThreadPooling'&nbsp;with&nbsp;2&nbsp;secondary&nbsp;threads:&quot;</span><br />
<span class="wrd">ThreadPoolingSequence</span><span class="oth">(</span><span class="num">2</span><span class="oth">)</span><br />
<span class="key">Print</span><br />
<br />
<span class="com">'---------------------------------------------------</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;'ThreadInitThenMultiStart'&nbsp;with&nbsp;4&nbsp;secondary&nbsp;threads:&quot;</span><br />
<span class="wrd">ThreadInitThenMultiStartSequence</span><span class="oth">(</span><span class="num">4</span><span class="oth">)</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;'ThreadPooling'&nbsp;with&nbsp;4&nbsp;secondary&nbsp;threads:&quot;</span><br />
<span class="wrd">ThreadPoolingSequence</span><span class="oth">(</span><span class="num">4</span><span class="oth">)</span><br />
<span class="key">Print</span><br />
<br />
<span class="com">'---------------------------------------------------</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;'ThreadInitThenMultiStart'&nbsp;with&nbsp;8&nbsp;secondary&nbsp;threads:&quot;</span><br />
<span class="wrd">ThreadInitThenMultiStartSequence</span><span class="oth">(</span><span class="num">8</span><span class="oth">)</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;'ThreadPooling'&nbsp;with&nbsp;8&nbsp;secondary&nbsp;threads:&quot;</span><br />
<span class="wrd">ThreadPoolingSequence</span><span class="oth">(</span><span class="num">8</span><span class="oth">)</span><br />
<span class="key">Print</span><br />
<br />
<span class="com">'---------------------------------------------------</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;'ThreadInitThenMultiStart'&nbsp;with&nbsp;16&nbsp;secondary&nbsp;threads:&quot;</span><br />
<span class="wrd">ThreadInitThenMultiStartSequence</span><span class="oth">(</span><span class="num">16</span><span class="oth">)</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;'ThreadPooling'&nbsp;with&nbsp;16&nbsp;secondary&nbsp;threads:&quot;</span><br />
<span class="wrd">ThreadPoolingSequence</span><span class="oth">(</span><span class="num">16</span><span class="oth">)</span><br />
<span class="key">Print</span><br />
<br />
<span class="com">'---------------------------------------------------</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;'ThreadInitThenMultiStart'&nbsp;with&nbsp;32&nbsp;secondary&nbsp;threads:&quot;</span><br />
<span class="wrd">ThreadInitThenMultiStartSequence</span><span class="oth">(</span><span class="num">32</span><span class="oth">)</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;'ThreadPooling'&nbsp;with&nbsp;32&nbsp;secondary&nbsp;threads:&quot;</span><br />
<span class="wrd">ThreadPoolingSequence</span><span class="oth">(</span><span class="num">32</span><span class="oth">)</span><br />
<span class="key">Print</span><br />
<br />
<span class="key">Sleep</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
Output example:<br \>
<div class="fb_indent"><pre class="fb_pre">
'ThreadInitThenMultiStart' with 1 secondary thread:
   00112233445566778899AABBCCDDEEFFGGHHIIJJKKLLMMNNOOPPQQRRSSTTUUVV :    7.38 s
'ThreadPooling' with 1 secondary thread:
   00112233445566778899AABBCCDDEEFFGGHHIIJJKKLLMMNNOOPPQQRRSSTTUUVV :    7.37 s

'ThreadInitThenMultiStart' with 2 secondary threads:
   01102332455476768998ABABCDDCEFEFHGHGIJJIKLKLMNMNPOPOQRRQSTSTUVUV :    3.88 s
'ThreadPooling' with 2 secondary threads:
   01012332454567678989ABABCDCDEFEFGHHGJIJILKLKNMNMPOPORQRQTSTSUVVU :    3.87 s

'ThreadInitThenMultiStart' with 4 secondary threads:
   012331204657564789ABA8B9CFDEFEDCGHJIHJGIKNLMMNLKOPQRPRQOSTUVUVTS :    2.11 s
'ThreadPooling' with 4 secondary threads:
   012303214567456789AB8A9BCEDFCEDFGIHJGIHJKMNLKMLNOQRPOQPRSUTVSUTV :    2.09 s

'ThreadInitThenMultiStart' with 8 secondary threads:
   01234567473651208A9BCEDFBA98FDECGHIJLKMNIHGJNKMLOPQSRTVUSPOQUVTR :    2.21 s
'ThreadPooling' with 8 secondary threads:
   0123456712306547A8B9FADCE9B8ECDIFMKGJHNIKJLGHMSQRLNPUOTVRQSPUVTO :    2.10 s

'ThreadInitThenMultiStart' with 16 secondary threads:
   0123456789ABCDEF5380AC4679BD12FEGHIKJLMNOPQRSUVTJNLGHIMOKPURVSTQ :    2.16 s
'ThreadPooling' with 16 secondary threads:
   0123465789ABCDEF3102658A97CB4HFJLMIGOEDNRSPKVQHJOIUGTPKRMNSLQUTV :    2.15 s

'ThreadInitThenMultiStart' with 32 secondary threads:
   0123457698ABDCEFGHIKLJNOMPRQSTVU05743218A69BFECDKHIGLJMTRPSVQOUN :    2.12 s
'ThreadPooling' with 32 secondary threads:
   0V23546789ACBDFEIHGJKMLNOPQRSTU1V3024C78D5F6B9AHGMLKJIEORSPQUT1N :    2.09 s
								</pre>Note: From a certain number of threads used, the gain in execution time becomes more or less constant (even slightly decreasing), which corresponds roughly to the number of threads the used CPU really has (4 in the case above).<br \>
<br \>
</div></div></div></div></div></div></div><ul><ul><ul><ul><li> Warning when using dynamic instances of such Types:<br \>
</ul></ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent">When using dynamic instances of these types, their addresses should not be changed during their lifetimes, due to the associated internal thread that constantly accesses the data members from a pointer passed once to the thread beginning:<br \>
<div class="fb_indent"><b>-</b> Thus, the use of <tt>Redim Preserve</tt> or <tt>Reallocate</tt> on such Type instances is prohibited, otherwise the program crashes.<br \>
<b>-</b> One solution is to use dynamic pointers to such Type instances instead, so that the addresses of these pointers can be changed without their values changing.<br \>
<br \>
</div></div></div></div></div></div><ul><ul><li> <b>ThreadDispatching</b> Type, over-structure of <b>ThreadPooling</b> Type, dispatching user thread procedures over a given max number of secondary threads:<br \>
<ul><ul><li> Principle:<br \>
</ul></ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent">The maximum number of secondary threads that can be used is fixed when constructing the 'ThreadDispatching' instance (1 secondary thread by default).<br \>
'ThreadDispatching' manages an internal dynamic array of pointers to 'ThreadPooling' instances.<br \>
<br \>
If a secondary thread is available (already existing instance of 'ThreadPooling' pending), it is used to submit the user thread procedure.<br \>
Otherwise, a new secondary thread is created (new instance of 'ThreadPooling' created) by respecting the number of secondary threads allowed.<br \>
As long as all potential secondary threads are already in use, each new user thread procedure is distributed evenly over them.<br \>
<br \>
</div></div></div></div></div><ul><ul><ul><ul><li> Description:<br \>
</ul></ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent">Methods:<br \>
<div class="fb_indent"><b>-</b> Constructor : Construct a 'ThreadDispatching' instance and set the number of usable secondary threads (1 by default).<br \>
<b>-</b> DispatchingSubmit : Enter a user thread procedure in the queue of the "best" secondary thread among the usable ones.<br \>
<b>-</b> DispatchingWait : Wait for the complete emptying of the queues of all secondary threads used (with all last user procedures executed).<br \>
<b>-</b> DispatchingThread : Return the number of internal threads really started.<br \>
<b>-</b> Destructor : Stop and complete the secondary threads used.<br \>
<br \>
</div></div></div></div></div></div><ul><ul><ul><ul><li> Example:<br \>
</ul></ul></ul></ul><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent"><div class="fb_indent">Example of use of 'ThreadDispatching' (whatever the allowed number of secondary threads, the submission sequence syntax is always the same):<br \>
<div class="fb_indent"><tt><div class="freebasic">
<span class="def">#include&nbsp;Once&nbsp;&quot;crt/string.bi&quot;<br />
</span><span class="key">Type</span>&nbsp;<span class="wrd">ThreadPooling</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Public</span><span class="oth">:</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Constructor</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">PoolingSubmit</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">pThread</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">PoolingWait</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">PoolingWait</span><span class="oth">(</span><span class="wrd">values</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Property</span>&nbsp;<span class="wrd">PoolingState</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UByte</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Destructor</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Private</span><span class="oth">:</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">_pThread0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_p0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">_pThread</span><span class="oth">(</span><span class="key">Any</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_p</span><span class="oth">(</span><span class="key">Any</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_mutex</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_cond1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_cond2</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_pt</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Byte</span>&nbsp;<span class="wrd">_end</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">_returnF</span><span class="oth">(</span><span class="key">Any</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UByte</span>&nbsp;<span class="wrd">_state</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Static</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">_Thread</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Type</span><br />
<br />
<span class="key">Constructor</span>&nbsp;<span class="wrd">ThreadPooling</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="wrd">This._pThread</span><span class="oth">(</span><span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="wrd">This._p</span><span class="oth">(</span><span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="wrd">This._returnF</span><span class="oth">(</span><span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._mutex</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">MutexCreate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._cond1</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">CondCreate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._cond2</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">CondCreate</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._pt</span><span class="oth">=</span>&nbsp;<span class="key">ThreadCreate</span><span class="oth">(@</span><span class="wrd">ThreadPooling._Thread</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="key">This</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Constructor</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadPooling.PoolingSubmit</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">pThread</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">This._pThread</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._pThread</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._pThread</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._pThread</span><span class="oth">))</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">pThread</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">This._p</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._p</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._p</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._p</span><span class="oth">))</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondSignal</span><span class="oth">(</span><span class="wrd">This._cond2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadPooling.PoolingWait</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">While</span>&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="num">4</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondWait</span><span class="oth">(</span><span class="wrd">This._Cond1</span><span class="oth">,</span>&nbsp;<span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Wend</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="wrd">This._returnF</span><span class="oth">(</span><span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadPooling.PoolingWait</span><span class="oth">(</span><span class="wrd">values</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">While</span>&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">&lt;&gt;</span>&nbsp;<span class="num">4</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondWait</span><span class="oth">(</span><span class="wrd">This._Cond1</span><span class="oth">,</span>&nbsp;<span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Wend</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._returnF</span><span class="oth">)</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="wrd">values</span><span class="oth">(</span><span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._returnF</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._returnF</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">values</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">This._returnF</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="wrd">This._returnF</span><span class="oth">(</span><span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Else</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Erase</span>&nbsp;<span class="wrd">values</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Property</span>&nbsp;<span class="wrd">ThreadPooling.PoolingState</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">UByte</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="wrd">This._state</span><br />
<span class="key">End</span>&nbsp;<span class="key">Property</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadPooling._Thread</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">ThreadPooling</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">pThis</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Do</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">4</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondSignal</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_cond1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">While</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondWait</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_cond2</span><span class="oth">,</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_end</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">Then</span>&nbsp;<span class="key">Exit</span>&nbsp;<span class="key">Sub</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Wend</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread0</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">(</span><span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p0</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">(</span><span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">)</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">memmove</span><span class="oth">(@</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">(</span><span class="num">1</span><span class="oth">),</span>&nbsp;<span class="oth">@</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">(</span><span class="num">2</span><span class="oth">),</span>&nbsp;<span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">)</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><span class="oth">)</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">SizeOf</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">memmove</span><span class="oth">(@</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">(</span><span class="num">1</span><span class="oth">),</span>&nbsp;<span class="oth">@</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">(</span><span class="num">2</span><span class="oth">),</span>&nbsp;<span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">)</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><span class="oth">)</span>&nbsp;<span class="oth">*</span>&nbsp;<span class="key">SizeOf</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread</span><span class="oth">)</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p</span><span class="oth">)</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_ReturnF</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_returnF</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_state</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">2</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_returnF</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_returnF</span><span class="oth">))</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_pThread0</span><span class="oth">(</span><span class="wrd">pThis</span><span class="oth">-&gt;</span><span class="wrd">_p0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Loop</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Destructor</span>&nbsp;<span class="wrd">ThreadPooling</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexLock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._end</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondSignal</span><span class="oth">(</span><span class="wrd">This._cond2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexUnlock</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="oth">.</span><span class="key">ThreadWait</span><span class="oth">(</span><span class="wrd">This._pt</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">MutexDestroy</span><span class="oth">(</span><span class="wrd">This._mutex</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondDestroy</span><span class="oth">(</span><span class="wrd">This._cond1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">CondDestroy</span><span class="oth">(</span><span class="wrd">This._cond2</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Destructor</span><br />
<br />
<span class="com">'---------------------------------------------------</span><br />
<br />
<span class="key">Type</span>&nbsp;<span class="wrd">ThreadDispatching</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Public</span><span class="oth">:</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Constructor</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">nbMaxSecondaryThread</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">DispatchingSubmit</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">pThread</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">DispatchingWait</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Sub</span>&nbsp;<span class="wrd">DispatchingWait</span><span class="oth">(</span><span class="wrd">values</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Property</span>&nbsp;<span class="wrd">DispatchingThread</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Declare</span>&nbsp;<span class="key">Destructor</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Private</span><span class="oth">:</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">_nbmst</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="wrd">_dstnb</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">ThreadPooling</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">_tp</span><span class="oth">(</span><span class="key">Any</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Type</span><br />
<br />
<span class="key">Constructor</span>&nbsp;<span class="wrd">ThreadDispatching</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">nbMaxSecondaryThread</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._nbmst</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">nbMaxSecondaryThread</span><br />
<span class="key">End</span>&nbsp;<span class="key">Constructor</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadDispatching.DispatchingSubmit</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">pThread</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Function</span><span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._tp</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="oth">(</span><span class="wrd">This._tp</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)-&gt;</span><span class="wrd">PoolingState</span>&nbsp;<span class="key">And</span>&nbsp;<span class="num">3</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._tp</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)-&gt;</span><span class="wrd">PoolingSubmit</span><span class="oth">(</span><span class="wrd">pThread</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Exit</span>&nbsp;<span class="key">Sub</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._tp</span><span class="oth">)</span>&nbsp;<span class="oth">&lt;</span>&nbsp;<span class="wrd">This._nbmst</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">This._tp</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._tp</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._tp</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._tp</span><span class="oth">))</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">New</span>&nbsp;<span class="wrd">ThreadPooling</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._tp</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._tp</span><span class="oth">))-&gt;</span><span class="wrd">PoolingSubmit</span><span class="oth">(</span><span class="wrd">pThread</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ElseIf</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._tp</span><span class="oth">)</span>&nbsp;<span class="oth">&gt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._tp</span><span class="oth">(</span><span class="wrd">This._dstnb</span><span class="oth">)-&gt;</span><span class="wrd">PoolingSubmit</span><span class="oth">(</span><span class="wrd">pThread</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._dstnb</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="oth">(</span><span class="wrd">This._dstnb</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span>&nbsp;<span class="key">Mod</span>&nbsp;<span class="wrd">This._nbmst</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadDispatching.DispatchingWait</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._tp</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._tp</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)-&gt;</span><span class="wrd">PoolingWait</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">ThreadDispatching.DispatchingWait</span><span class="oth">(</span><span class="wrd">values</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">s</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._tp</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">This._tp</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)-&gt;</span><span class="wrd">PoolingWait</span><span class="oth">(</span><span class="wrd">s</span><span class="oth">())</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">s</span><span class="oth">)</span>&nbsp;<span class="oth">&gt;=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">values</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="oth">-</span><span class="num">1</span>&nbsp;<span class="key">Then</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">values</span><span class="oth">(</span><span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">values</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">s</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Else</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">ReDim</span>&nbsp;<span class="key">Preserve</span>&nbsp;<span class="wrd">values</span><span class="oth">(</span><span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">values</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">s</span><span class="oth">))</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">s</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">values</span><span class="oth">(</span><span class="key">UBound</span><span class="oth">(</span><span class="wrd">values</span><span class="oth">)</span>&nbsp;<span class="oth">-</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">s</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="wrd">I</span><span class="oth">)</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">s</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">End</span>&nbsp;<span class="key">If</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Property</span>&nbsp;<span class="wrd">ThreadDispatching.DispatchingThread</span><span class="oth">()</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._tp</span><span class="oth">)</span>&nbsp;<span class="oth">+</span>&nbsp;<span class="num">1</span><br />
<span class="key">End</span>&nbsp;<span class="key">Property</span><br />
<br />
<span class="key">Destructor</span>&nbsp;<span class="wrd">ThreadDispatching</span><span class="oth">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">To</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">This._tp</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Delete</span>&nbsp;<span class="wrd">This._tp</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="key">End</span>&nbsp;<span class="key">Destructor</span><br />
<br />
<span class="com">'---------------------------------------------------</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">Prnt</span>&nbsp;<span class="oth">(</span><span class="key">ByRef</span>&nbsp;<span class="wrd">s</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="key">Ptr</span>&nbsp;<span class="wrd">ps</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="wrd">p</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">If</span>&nbsp;<span class="wrd">ps</span>&nbsp;<span class="oth">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="key">Then</span>&nbsp;<span class="key">Print</span>&nbsp;<span class="oth">*</span><span class="wrd">ps</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="key">To</span>&nbsp;<span class="num">10</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="wrd">s</span><span class="oth">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Sleep</span>&nbsp;<span class="num">100</span><span class="oth">,</span>&nbsp;<span class="num">1</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">UserCode1</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">Prnt</span><span class="oth">(</span><span class="quo">&quot;1&quot;</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="quo">&quot;UserCode&nbsp;#1&quot;</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">UserCode2</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">Prnt</span><span class="oth">(</span><span class="quo">&quot;2&quot;</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="quo">&quot;UserCode&nbsp;#2&quot;</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">UserCode3</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">Prnt</span><span class="oth">(</span><span class="quo">&quot;3&quot;</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="quo">&quot;UserCode&nbsp;#3&quot;</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">UserCode4</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">Prnt</span><span class="oth">(</span><span class="quo">&quot;4&quot;</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="quo">&quot;UserCode&nbsp;#4&quot;</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">UserCode5</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">Prnt</span><span class="oth">(</span><span class="quo">&quot;5&quot;</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="quo">&quot;UserCode&nbsp;#5&quot;</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Function</span>&nbsp;<span class="wrd">UserCode6</span>&nbsp;<span class="oth">(</span><span class="key">ByVal</span>&nbsp;<span class="wrd">p</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Any</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">Prnt</span><span class="oth">(</span><span class="quo">&quot;6&quot;</span><span class="oth">,</span>&nbsp;<span class="wrd">p</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Return</span>&nbsp;<span class="quo">&quot;UserCode&nbsp;#6&quot;</span><br />
<span class="key">End</span>&nbsp;<span class="key">Function</span><br />
<br />
<span class="key">Sub</span>&nbsp;<span class="wrd">SubmitSequence</span><span class="oth">(</span><span class="key">ByRef</span>&nbsp;<span class="wrd">t</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">ThreadDispatching</span><span class="oth">,</span>&nbsp;<span class="key">ByVal</span>&nbsp;<span class="wrd">ps</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="key">Ptr</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">t.DispatchingSubmit</span><span class="oth">(@</span><span class="wrd">UserCode1</span><span class="oth">,</span>&nbsp;<span class="wrd">ps</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">t.DispatchingSubmit</span><span class="oth">(@</span><span class="wrd">UserCode2</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">t.DispatchingSubmit</span><span class="oth">(@</span><span class="wrd">UserCode3</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">t.DispatchingSubmit</span><span class="oth">(@</span><span class="wrd">UserCode4</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">t.DispatchingSubmit</span><span class="oth">(@</span><span class="wrd">UserCode5</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="wrd">t.DispatchingSubmit</span><span class="oth">(@</span><span class="wrd">UserCode6</span><span class="oth">)</span><br />
<span class="key">End</span>&nbsp;<span class="key">Sub</span>&nbsp;&nbsp;&nbsp;<br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">sa</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;Sequence&nbsp;#a:&nbsp;&quot;</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">sb</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;Sequence&nbsp;#b:&nbsp;&quot;</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">sc</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;Sequence&nbsp;#c:&nbsp;&quot;</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">sd</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;Sequence&nbsp;#d:&nbsp;&quot;</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">se</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;Sequence&nbsp;#e:&nbsp;&quot;</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">sf</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;Sequence&nbsp;#f:&nbsp;&quot;</span><br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">String</span>&nbsp;<span class="wrd">s</span><span class="oth">()</span><br />
<br />
<span class="key">Dim</span>&nbsp;<span class="key">As</span>&nbsp;<span class="wrd">ThreadDispatching</span>&nbsp;<span class="wrd">t1</span><span class="oth">,</span>&nbsp;<span class="wrd">t2</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">2</span><span class="oth">,</span>&nbsp;<span class="wrd">t3</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">3</span><span class="oth">,</span>&nbsp;<span class="wrd">t4</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">4</span><span class="oth">,</span>&nbsp;<span class="wrd">t5</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">5</span><span class="oth">,</span>&nbsp;<span class="wrd">t6</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="num">6</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;Sequence&nbsp;#a&nbsp;of&nbsp;6&nbsp;user&nbsp;thread&nbsp;functions&nbsp;dispatched&nbsp;over&nbsp;1&nbsp;secondary&nbsp;thread:&quot;</span><br />
<span class="wrd">SubmitSequence</span><span class="oth">(</span><span class="wrd">t1</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">sa</span><span class="oth">)</span><br />
<span class="wrd">t1.DispatchingWait</span><span class="oth">()</span><br />
<span class="key">Print</span><br />
<span class="key">Print</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;Sequence&nbsp;#b&nbsp;of&nbsp;6&nbsp;user&nbsp;thread&nbsp;functions&nbsp;dispatched&nbsp;over&nbsp;2&nbsp;secondary&nbsp;threads:&quot;</span><br />
<span class="wrd">SubmitSequence</span><span class="oth">(</span><span class="wrd">t2</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">sb</span><span class="oth">)</span><br />
<span class="wrd">t2.DispatchingWait</span><span class="oth">()</span><br />
<span class="key">Print</span><br />
<span class="key">Print</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;Sequence&nbsp;#c&nbsp;of&nbsp;6&nbsp;user&nbsp;thread&nbsp;functions&nbsp;dispatched&nbsp;over&nbsp;3&nbsp;secondary&nbsp;threads:&quot;</span><br />
<span class="wrd">SubmitSequence</span><span class="oth">(</span><span class="wrd">t3</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">sc</span><span class="oth">)</span><br />
<span class="wrd">t3.DispatchingWait</span><span class="oth">()</span><br />
<span class="key">Print</span><br />
<span class="key">Print</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;Sequence&nbsp;#d&nbsp;of&nbsp;6&nbsp;user&nbsp;thread&nbsp;functions&nbsp;dispatched&nbsp;over&nbsp;4&nbsp;secondary&nbsp;threads:&quot;</span><br />
<span class="wrd">SubmitSequence</span><span class="oth">(</span><span class="wrd">t4</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">sd</span><span class="oth">)</span><br />
<span class="wrd">t4.DispatchingWait</span><span class="oth">()</span><br />
<span class="key">Print</span><br />
<span class="key">Print</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;Sequence&nbsp;#e&nbsp;of&nbsp;6&nbsp;user&nbsp;thread&nbsp;functions&nbsp;dispatched&nbsp;over&nbsp;5&nbsp;secondary&nbsp;threads:&quot;</span><br />
<span class="wrd">SubmitSequence</span><span class="oth">(</span><span class="wrd">t5</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">se</span><span class="oth">)</span><br />
<span class="wrd">t5.DispatchingWait</span><span class="oth">()</span><br />
<span class="key">Print</span><br />
<span class="key">Print</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;Sequence&nbsp;#f&nbsp;of&nbsp;6&nbsp;user&nbsp;thread&nbsp;functions&nbsp;dispatched&nbsp;over&nbsp;6&nbsp;secondary&nbsp;threads:&quot;</span><br />
<span class="wrd">SubmitSequence</span><span class="oth">(</span><span class="wrd">t6</span><span class="oth">,</span>&nbsp;<span class="oth">@</span><span class="wrd">sf</span><span class="oth">)</span><br />
<span class="wrd">t6.DispatchingWait</span><span class="oth">(</span><span class="wrd">s</span><span class="oth">())</span><br />
<span class="key">Print</span><br />
<br />
<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;List&nbsp;of&nbsp;returned&nbsp;values&nbsp;from&nbsp;sequence&nbsp;#f:&quot;</span><br />
<span class="key">For</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="key">As</span>&nbsp;<span class="key">Integer</span>&nbsp;<span class="oth">=</span>&nbsp;<span class="key">LBound</span><span class="oth">(</span><span class="wrd">s</span><span class="oth">)</span>&nbsp;<span class="key">To</span>&nbsp;<span class="key">UBound</span><span class="oth">(</span><span class="wrd">s</span><span class="oth">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span class="key">Print</span>&nbsp;<span class="quo">&quot;&nbsp;&nbsp;&nbsp;&quot;</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="wrd">I</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="quo">&quot;:&nbsp;&quot;</span>&nbsp;<span class="oth">&amp;</span>&nbsp;<span class="wrd">s</span><span class="oth">(</span><span class="wrd">I</span><span class="oth">)</span><br />
<span class="key">Next</span>&nbsp;<span class="wrd">I</span><br />
<br />
<span class="key">Sleep</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></tt><br />
Output:<br \>
<div class="fb_indent"><pre class="fb_pre">
 Sequence #a of 6 user thread functions dispatched over 1 secondary thread:
  Sequence #a: 111111111122222222223333333333444444444455555555556666666666

 Sequence #b of 6 user thread functions dispatched over 2 secondary threads:
  Sequence #b: 122112121212122112213434344343344343344356566565565656565665

 Sequence #c of 6 user thread functions dispatched over 3 secondary threads:
  Sequence #c: 123123312321213132321231213321465654546465546546456654654564

 Sequence #d of 6 user thread functions dispatched over 4 secondary threads:
  Sequence #d: 134243211234432114322341413241233124413256655656566556655656

 Sequence #e of 6 user thread functions dispatched over 5 secondary threads:
  Sequence #e: 134255243141235325415143215234342511524343521251346666666666

 Sequence #f of 6 user thread functions dispatched over 6 secondary threads:
  Sequence #f: 534126216354456132241365563142421365316524245613361245365421
  List of returned values from sequence #f:
   1: UserCode #1
   2: UserCode #2
   3: UserCode #3
   4: UserCode #4
   5: UserCode #5
   6: UserCode #6
								</pre></div></div></div></div></div></div></div><div style="text-align: center;"><a href="#ProPgMtCriticalSectionsFAQtop">Back to top</a></div><br \>
<br \>
</div><div class="fb_sect_title">See also</div><div class="fb_sect_cont"><br \>
<ul><li> <a href="ProPgMultiThreading.html">Multi-Threading Overview</a><br \>
<li> <a href="ProPgMtThreads.html">Threads</a><br \>
<li> <a href="ProPgMtMutualExclusion.html">Mutual Exclusion</a><br \>
<li> <a href="ProPgMtConditionalVariables.html">Conditional Variables</a><br \>
<li> <a href="ProPgMtCriticalSections.html">Critical Sections</a><br \>
<br \>
</ul></div>
</div>
</div> 
</div> 
</body>
</html>
